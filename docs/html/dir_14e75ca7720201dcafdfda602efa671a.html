<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ComPPare: examples/advanced_demo/4-DoNotOptimize Directory Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ComPPare<span id="projectnumber">&#160;1.0.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('dir_14e75ca7720201dcafdfda602efa671a.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">4-DoNotOptimize Directory Reference</div></div>
</div><!--header-->
<div class="contents">

<p><p>Full AArch64 Assembly code of <code><a class="el" href="_do_not_optimize__demo_8cpp.html#a0b3e578501d76859fa31815d0c3b9ef9">SAXPY_DONOTOPTIMIZE()</a></code> with <code>-O3</code> optimization. </p>
 
<a href="#details">More...</a></p>
<div class="dynheader">
Directory dependency graph for 4-DoNotOptimize:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" loading="lazy" frameborder="0" src="dir_14e75ca7720201dcafdfda602efa671a_dep.svg" width="270" height="168"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 id="header-subdirs" class="groupheader"><a id="subdirs" name="subdirs"></a>
Directories</h2></td></tr>
<tr class="memitem:build" id="r_build"><td class="memItemLeft" align="right" valign="top"><span class="iconfolder"><div class="folder-icon"></div></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dir_d16ef018ff3f349186211457310dba0f.html">build</a></td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 id="header-files" class="groupheader"><a id="files" name="files"></a>
Files</h2></td></tr>
<tr class="memitem:DoNotOptimize_5Fdemo_2Ecpp" id="r_DoNotOptimize_5Fdemo_2Ecpp"><td class="memItemLeft" align="right" valign="top"><span class="icondoc"><div class="doc-icon"></div></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="_do_not_optimize__demo_8cpp.html">DoNotOptimize_demo.cpp</a></td></tr>
<tr class="memitem:saxpy_2Ecpp" id="r_saxpy_2Ecpp"><td class="memItemLeft" align="right" valign="top"><span class="icondoc"><div class="doc-icon"></div></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="saxpy_8cpp.html">saxpy.cpp</a></td></tr>
<tr class="memitem:saxpy_5FDoNotOptimize_2Ecpp" id="r_saxpy_5FDoNotOptimize_2Ecpp"><td class="memItemLeft" align="right" valign="top"><span class="icondoc"><div class="doc-icon"></div></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="saxpy___do_not_optimize_8cpp.html">saxpy_DoNotOptimize.cpp</a></td></tr>
</table>
<a name="details" id="details"></a><h2 id="header-details" class="groupheader">Detailed Description</h2>
<p>Full AArch64 Assembly code of <code><a class="el" href="_do_not_optimize__demo_8cpp.html#a0b3e578501d76859fa31815d0c3b9ef9">SAXPY_DONOTOPTIMIZE()</a></code> with <code>-O3</code> optimization. </p>
<p>&lt;style&gt; details summary { list-style: none; margin: 1em 0 0.5em; font-size: 1.125em; font-weight: bold; cursor: pointer; }</p>
<p>details summary::-webkit-details-marker { display: none; }</p>
<p>details summary::before { content: "▶"; display: inline-block; font-size: 1.5em; line-height: 1; margin-right: 0.5em; transition: transform 0.2s ease; }</p>
<p>details[open] summary::before { content: "▼"; } &lt;/style&gt;</p>
<h1>Advanced Demo 4 — <b>DoNotOptimize</b> </h1>
<ul>
<li>1. Introduction</li>
<li>2. Quick Start<ul>
<li>2.1. Build</li>
<li>2.2. Run</li>
<li>2.3. Results<ul>
<li>2.3.1. Interpreting Results</li>
</ul>
</li>
</ul>
</li>
<li>3. Problem of Optimization<ul>
<li>3.0.1. On AArch64 (Apple M2)</li>
<li>3.0.2. On x86\_64</li>
</ul>
</li>
<li>4. “Just don’t optimize”…?<ul>
<li>4.0.1. On AArch64 (Apple M2)</li>
<li>4.0.2. On x86\_64</li>
</ul>
</li>
</ul>
<p>4.1. Why Optimize?</p><ul>
<li>5. Google Benchmark's Solution<ul>
<li>5.1. On AArch64 (Apple M2)</li>
<li>5.2. On x86\_64<ul>
<li>5.2.1. Conclusion -- `DoNotOptimize()` works!</li>
</ul>
</li>
</ul>
</li>
<li>6. Inspecting `DoNotOptimize()`<ul>
<li>6.1. Breakdown 1: Assembly</li>
<li>6.2. Breakdown 2: Meaning of this asm code</li>
<li>6.3. Breakdown 3: `volatile`</li>
<li>6.4. Conclusion</li>
<li>6.5. `DoNotOptimize()` in practice</li>
</ul>
</li>
<li>7. Example Case<ul>
<li>7.1. Example Source Code</li>
<li>7.2. &quot;Performance&quot; difference</li>
<li>7.3. Compiler Warning</li>
<li>7.4. Inspection of the full asm code<ul>
<li>7.4.1. On AArch64 (Apple M2)</li>
<li>7.4.2. On x86\_64</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2>1. Introduction</h2>
<p>This example is used to demonstrate the functionality of <span class="tt"><a class="el" href="namespacecomppare.html#a047cefc5aebc47d079d502c2d189fe12" title="Prevents the compiler from optimizing away the given value.">comppare::DoNotOptimize()</a></span>. This function is an <b>EXACT COPY of Google Benchmark's <a href="https://github.com/google/benchmark">(github link)</a> <span class="tt">benchmark::DoNotOptimize()</span></b></p>
<p>This document will provide the explanation of the purpose, and mechanism of the function <span class="tt"><a class="el" href="saxpy___do_not_optimize_8cpp.html#a4800adc1dfab08974da980d447c594ea">DoNotOptimize()</a></span>.</p>
<h3>References: </h3>
<ol type="1">
<li><a href="https://www.youtube.com/watch?v=nXaxk27zwlk&amp;t=3319s">CppCon 2015: Chandler Carruth "Tuning C++: Benchmarks, and CPUs, and Compilers! Oh My!"</a> <br  />
</li>
<li><a href="https://github.com/google/benchmark">Google Benchmark Github Repository</a> <br  />
</li>
<li><a href="https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html#Clobbers-and-Scratch-Registers">GNU Extended ASM Documentation</a> <br  />
</li>
</ol>
<h3>Disclaimer </h3>
<p>I, LF Fung, am not the author of <span class="tt"><a class="el" href="saxpy___do_not_optimize_8cpp.html#a4800adc1dfab08974da980d447c594ea">DoNotOptimize()</a></span>. The implementation of <span class="tt"><a class="el" href="namespacecomppare.html#a047cefc5aebc47d079d502c2d189fe12" title="Prevents the compiler from optimizing away the given value.">comppare::DoNotOptimize()</a></span> is a verbatim of Google Benchmark's <span class="tt">benchmark::DoNotOptimize()</span>.</p>
<h2>2. Quick Start</h2>
<h3>2.1. Build</h3>
<div class="fragment"><div class="line">mkdir build </div>
<div class="line">cd build</div>
<div class="line">cmake .. -DCMAKE_BUILD_TYPE=Release</div>
<div class="line">make </div>
</div><!-- fragment --><h4>1.1.1.1. (Optional) Build with Google Benchmark </h4>
<p>At the CMake step: </p><div class="fragment"><div class="line">cmake .. -DCMAKE_BUILD_TYPE=Release -DUSE_GOOGLE_BENCHMARK=ON</div>
</div><!-- fragment --><h3>2.2. Run</h3>
<div class="fragment"><div class="line">./DoNotOptimize_demo --warmup 10000 --iters 10000</div>
</div><!-- fragment --><h3>2.3. Results</h3>
<p><b>On AArch64 Apple M2</b> </p><div class="fragment"><div class="line">*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=</div>
<div class="line">============ ComPPare Framework ============</div>
<div class="line">=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*</div>
<div class="line"> </div>
<div class="line">Number of implementations:             2</div>
<div class="line">Warmup iterations:                 10000</div>
<div class="line">Benchmark iterations:              10000</div>
<div class="line">=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*</div>
<div class="line"> </div>
<div class="line">Implementation             Func µs/Iter        ROI µs/Iter       Ovhd µs/Iter</div>
<div class="line">SAXPY                               0.00                0.00                0.00</div>
<div class="line">SAXPY_DONOTOPTIMIZE                57.14               28.60               28.54</div>
</div><!-- fragment --><p><b>Additional Results from Google Benchmark</b> </p><div class="fragment"><div class="line">--------------------------------------------------------------</div>
<div class="line">Benchmark                    Time             CPU   Iterations</div>
<div class="line">--------------------------------------------------------------</div>
<div class="line">SAXPY                    0.000 ns        0.000 ns   1000000000000</div>
<div class="line">SAXPY_DONOTOPTIMIZE      28594 ns        28427 ns        25001</div>
</div><!-- fragment --><hr  />
 <h4>2.3.1. Interpreting Results</h4>
<p>If you inspect <span class="tt"><a class="el" href="_do_not_optimize__demo_8cpp.html">DoNotOptimize_demo.cpp</a></span>, both functions are practically the same, with the exception of an addition of <span class="tt"><a class="el" href="saxpy___do_not_optimize_8cpp.html#a4800adc1dfab08974da980d447c594ea">DoNotOptimize()</a></span>. Read below to breakdown the reason to this performance difference.</p>
<h2>3. Problem of Optimization</h2>
<p>Compiler optimization can sometimes remove operations and variables completely.</p>
<p>In <span class="tt"><a class="el" href="saxpy_8cpp.html">saxpy.cpp</a></span>:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="_do_not_optimize__demo_8cpp.html#aa5b565b3eee10d362eab37bebfbd199e">SAXPY</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> a, <span class="keyword">const</span> <span class="keywordtype">float</span>* x, <span class="keyword">const</span> <span class="keywordtype">float</span>* y)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">float</span> yout;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code hl_define" href="manual__timing__demo_8cpp.html#a0240ac851181b84ac374872dc5434ee4">N</a>; ++i)</div>
<div class="line">    {</div>
<div class="line">        yout = a * x[i] + y[i];</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="a_do_not_optimize__demo_8cpp_html_aa5b565b3eee10d362eab37bebfbd199e"><div class="ttname"><a href="_do_not_optimize__demo_8cpp.html#aa5b565b3eee10d362eab37bebfbd199e">SAXPY</a></div><div class="ttdeci">void SAXPY(const float a, const float *x, const float *y)</div><div class="ttdef"><b>Definition</b> DoNotOptimize_demo.cpp:8</div></div>
<div class="ttc" id="amanual__timing__demo_8cpp_html_a0240ac851181b84ac374872dc5434ee4"><div class="ttname"><a href="manual__timing__demo_8cpp.html#a0240ac851181b84ac374872dc5434ee4">N</a></div><div class="ttdeci">#define N</div><div class="ttdef"><b>Definition</b> manual_timing_demo.cpp:7</div></div>
</div><!-- fragment --><p>When compiling at high optimization, the compiler realizes <span class="tt">yout</span> is just a temporary that’s never used elsewhere. As a result, <span class="tt">yout</span> is optimized out, and thus the whole saxpy operation would be optimized out.</p>
<p>To verify that it’s been optimized away, compile to assembly and inspect the output:</p>
<div class="fragment"><div class="line">export CXX=g++ #or your choice of compiler</div>
<div class="line">${CXX} -O3 -std=c++20 -S -o saxpy.s saxpy.cpp</div>
</div><!-- fragment --><hr  />
<h4>3.0.1. On AArch64 (Apple M2)</h4>
<p><span class="tt">saxpy.s</span> compiled with <span class="tt">Apple clang version 15.0.0 (clang-1500.3.9.4)</span> on <span class="tt">arm64-apple-darwin23.1.0</span> (Apple M2 chip):</p>
<div class="fragment"><div class="line">__Z5SAXPYfPKfS0_:                       ; @_Z5SAXPYfPKfS0_</div>
<div class="line">    .cfi_startproc</div>
<div class="line">; %bb.0:</div>
<div class="line">    ret</div>
<div class="line">    .cfi_endproc</div>
<div class="line">                                        ; -- End function</div>
</div><!-- fragment --><p>The function body is practically empty: a single <span class="tt">ret</span> which is “return from subroutine” <a href="https://developer.arm.com/documentation/dui0802/b/A64-General-Instructions/RET">Arm A64 Instruction Set: <b>RET</b></a>. In simple terms, it just returns — nothing happens.</p>
<hr  />
<h4>3.0.2. On x86_64</h4>
<p>The same phenomenon appears on x86 as well.</p>
<p><span class="tt">saxpy.s</span> compiled with <span class="tt">g++ (GCC) 15.1.0</span> on <span class="tt">x86_64 Intel(R) Xeon(R) Platinum 8468</span></p>
<div class="fragment"><div class="line">_Z5SAXPYfPKfS0_:</div>
<div class="line">.LFB0:</div>
<div class="line">    .cfi_startproc</div>
<div class="line">    ret</div>
<div class="line">    .cfi_endproc</div>
</div><!-- fragment --><p>Intel® 64 and IA-32 Architectures Software Developer’s Manual Volume 2 (2A, 2B, 2C, &amp; 2D): Instruction Set Reference, A–Z: Vol. 2B, 4-560, <b>RET — Return from Procedure</b>.</p>
<hr  />
<h2>4. “Just don’t optimize”…?</h2>
<p>Compiling with <span class="tt">-O0</span> should prevent the loop from being optimized away. For the sake of verifying the effects of no optimisation, we can again compile to assembly. </p><div class="fragment"><div class="line">export CXX=g++ #or your choice of compiler</div>
<div class="line">${CXX} -O0 -std=c++20 -S -o saxpy.s saxpy.cpp</div>
</div><!-- fragment --><hr  />
<h4>4.0.1. On AArch64 (Apple M2)</h4>
<p><span class="tt">saxpy.s</span> compiled with <span class="tt">Apple clang version 15.0.0 (clang-1500.3.9.4)</span> on <span class="tt">arm64-apple-darwin23.1.0</span> (Apple M2 chip):</p>
<details >
<summary >
Full AArch64 Assembly code of <code>SAXPY()</code> with NO optimization </summary>
<pre><code class="language-asm">
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">5</span> __Z5SAXPYfPKfS0_:                       ; @_Z5SAXPYfPKfS0_
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">6</span>       .cfi_startproc
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">7</span> ; bb.0:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">8</span>       sub     sp, sp, #32
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">9</span>       .cfi_def_cfa_offset 32
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">10</span>      str     s0, [sp, #28]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">11</span>      str     x0, [sp, #16]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">12</span>      str     x1, [sp, #8]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">13</span>      str     wzr, [sp]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">14</span>      b       LBB0_1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">15</span> LBB0_1:                                 ; =&gt;This Inner Loop Header: Depth=1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">16</span>      ldr     w8, [sp]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">17</span>      mov     w9, #16960
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">18</span>      movk    w9, #15, lsl #16
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">19</span>      subs    w8, w8, w9
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">20</span>      cset    w8, ge
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">21</span>      tbnz    w8, #0, LBB0_4
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">22</span>      b       LBB0_2
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">23</span> LBB0_2:                                 ;   in Loop: Header=BB0_1 Depth=1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">24</span>      ldr     s0, [sp, #28]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">25</span>      ldr     x8, [sp, #16]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">26</span>      ldrsw   x9, [sp]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">27</span>      ldr     s1, [x8, x9, lsl #2]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">28</span>      ldr     x8, [sp, #8]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">29</span>      ldrsw   x9, [sp]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">30</span>      ldr     s2, [x8, x9, lsl #2]
<span style="display:inline-block;width:100%;white-space:pre;background-color:rgba(0, 255, 4, 0.49);border-radius:2px;"><span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">31</span>      fmadd   s0, s0, s1, s2</span>
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">32</span>      str     s0, [sp, #4]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">33</span>      b       LBB0_3
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">34</span> LBB0_3:                                 ;   in Loop: Header=BB0_1 Depth=1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">35</span>      ldr     w8, [sp]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">36</span>      add     w8, w8, #1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">37</span>      str     w8, [sp]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">38</span>      b       LBB0_1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">39</span> LBB0_4:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">40</span>      add     sp, sp, #32
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">41</span>      ret
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">42</span>      .cfi_endproc
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">42</span>                                        ; -- End function
</code></pre> </details>
<p><br  />
</p>
<p><a class="anchor" id="saxpyappleM2isa"></a> The SAXPY operation can be found as Fused-Multiply-Add instruction on line 31: </p><pre><code class="language-asm">
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">31</span>      fmadd   s0, s0, s1, s2
</code></pre><p><a href="https://developer.arm.com/documentation/ddi0602/2025-06/SIMD-FP-Instructions/FMADD--Floating-point-fused-multiply-add--scalar--">Reference to Arm A64 Instruction Set: <b>FMADD</b></a></p>
<hr  />
<h4>4.0.2. On x86_64</h4>
<p><span class="tt">saxpy.s</span> compiled with <span class="tt">g++ (GCC) 15.1.0</span> on <span class="tt">x86_64 Intel(R) Xeon(R) Platinum 8468</span></p>
<details >
<summary >
Full x86_64 Assembly code of <code>SAXPY()</code> with NO optimization </summary>
<pre><code class="language-asm">
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">5</span> _Z5SAXPYfPKfS0_:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">6</span> .LFB0:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">7</span>       .cfi_startproc
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">8</span>       pushq   rbp
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">9</span>       .cfi_def_cfa_offset 16
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">10</span>      .cfi_offset 6, -16
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">11</span>      movq    rsp, rbp
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">12</span>      .cfi_def_cfa_register 6
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">13</span>      movss   xmm0, -20(rbp)
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">14</span>      movq    rdi, -32(rbp)
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">15</span>      movq    rsi, -40(rbp)
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">16</span>      movl    $0, -4(rbp)
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">17</span>      jmp     .L2
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">18</span> .L3:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">19</span>      movl    -4(rbp), eax
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">20</span>      cltq
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">21</span>      leaq    0(,rax,4), rdx
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">22</span>      movq    -32(rbp), rax
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">23</span>      addq    rdx, rax
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">24</span>      movss   (rax), xmm0
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">25</span>      movaps  xmm0, xmm1
<span style="display:inline-block;width:100%;white-space:pre;background-color:rgba(0, 255, 4, 0.49);border-radius:2px;"><span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">26</span>      mulss   -20(rbp), xmm1</span>
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">27</span>      movl    -4(rbp), eax
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">28</span>      cltq
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">29</span>      leaq    0(,rax,4), rdx
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">30</span>      movq    -40(rbp), rax
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">31</span>      addq    rdx, rax
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">32</span>      movss   (rax), xmm0
<span style="display:inline-block;width:100%;white-space:pre;background-color:rgba(0, 255, 4, 0.49);border-radius:2px;"><span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">33</span>      addss   xmm1, xmm0</span>
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">34</span>      movss   xmm0, -8(rbp)
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">35</span>      addl    $1, -4(rbp)
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">36</span> .L2:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">37</span>      cmpl    $999999, -4(rbp)
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">38</span>      jle     .L3
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">39</span>      nop
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">40</span>      nop
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">41</span>      popq    rbp
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">42</span>      .cfi_def_cfa 7, 8
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">43</span>      ret
</code></pre> </details>
<p><br  />
</p>
<p><a class="anchor" id="saxpy_x86_isa"></a> The SAXPY operation can also be found as separate multiply and addition scalar operations: </p><pre><code class="language-asm">
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">26</span>      mulss   -20(rbp), xmm1 
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">33</span>      addss   xmm1, xmm0
</code></pre><p>Intel® 64 and IA-32 Architectures Software Developer’s Manual Volume 2 (2A, 2B, 2C, &amp; 2D): Instruction Set Reference, A–Z: Vol. 2B, 4-151, <b>MULSS — Multiply Scalar Single Precision Floating-Point Values</b>. Vol. 2A, 3-24 , <b>ADDSS—Add Scalar Single Precision Floating-Point Values</b>.</p>
<hr  />
<h3>4.1. Why Optimize?</h3>
<p>From these results, it shows that to avoid compiler optimizing away the operation is to simply turn off optimization completely. However, benchmarking the operations without optimisation may not be relavant to real-world performance as often production code are optimized. Therefore, we still need optimization, at the same time not optimize away the operation completely.</p>
<hr  />
<h2>5. Google Benchmark's Solution</h2>
<p>Optimization is important to understand the performance of particular operations in production builds. This creates the conflicting ideas of <span class="tt">optimize</span> but <span class="tt">do not optimize away</span>. This was solved by Google in their <a href="https://github.com/google/benchmark">benchmark</a> &ndash; a microbenchmarking library. Google Benchmark provides <span class="tt">benchmark::DoNotOptimize()</span> to prevent variables from being optimized away.</p>
<p>With the same SAXPY function, we simply add <a class="el" href="saxpy___do_not_optimize_8cpp.html#a4800adc1dfab08974da980d447c594ea">DoNotOptimize()</a> around the temporary variable <span class="tt">yout</span> </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="_do_not_optimize__demo_8cpp.html#a0b3e578501d76859fa31815d0c3b9ef9">SAXPY_DONOTOPTIMIZE</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> a, <span class="keyword">const</span> <span class="keywordtype">float</span>* x, <span class="keyword">const</span> <span class="keywordtype">float</span>* y)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">float</span> yout;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code hl_define" href="manual__timing__demo_8cpp.html#a0240ac851181b84ac374872dc5434ee4">N</a>; ++i)</div>
<div class="line">    {</div>
<div class="line">        yout = a * x[i] + y[i];</div>
<div class="line">        <a class="code hl_function" href="saxpy___do_not_optimize_8cpp.html#a4800adc1dfab08974da980d447c594ea">DoNotOptimize</a>(yout);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="a_do_not_optimize__demo_8cpp_html_a0b3e578501d76859fa31815d0c3b9ef9"><div class="ttname"><a href="_do_not_optimize__demo_8cpp.html#a0b3e578501d76859fa31815d0c3b9ef9">SAXPY_DONOTOPTIMIZE</a></div><div class="ttdeci">void SAXPY_DONOTOPTIMIZE(const float a, const float *x, const float *y)</div><div class="ttdef"><b>Definition</b> DoNotOptimize_demo.cpp:19</div></div>
<div class="ttc" id="asaxpy___do_not_optimize_8cpp_html_a4800adc1dfab08974da980d447c594ea"><div class="ttname"><a href="saxpy___do_not_optimize_8cpp.html#a4800adc1dfab08974da980d447c594ea">DoNotOptimize</a></div><div class="ttdeci">void DoNotOptimize(T &amp;value)</div><div class="ttdef"><b>Definition</b> saxpy_DoNotOptimize.cpp:20</div></div>
</div><!-- fragment --><p>This <span class="tt">DoNotOptimize</span> call tells the compiler not to eliminate the temporary variable, so the operation itself won’t be optimized away.</p>
<hr  />
<p> Compile with aggressive optimization and inspect the assembly:</p>
<div class="fragment"><div class="line">export CXX=g++ # or your choice of compiler</div>
<div class="line">${CXX} -O3 -std=c++20 -S -o saxpy_DoNotOptimize.s saxpy_DoNotOptimize.cpp</div>
</div><!-- fragment --><h3>5.1. On AArch64 (Apple M2)</h3>
<p>Compiled with <span class="tt">Apple clang version 15.0.0 (clang-1500.3.9.4)</span> on <span class="tt">arm64-apple-darwin23.1.0</span>:</p>
<pre><code class="language-asm">
   <span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">5</span> __Z19SAXPY_DONOTOPTIMIZEfPKfS0_:        ; @_Z19SAXPY_DONOTOPTIMIZEfPKfS0_
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">6</span>       .cfi_startproc
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">7</span> ; bb.0:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">8</span>       sub     sp, sp, #16
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">9</span>       .cfi_def_cfa_offset 16
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">10</span>      mov     w8, #16960
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">11</span>      movk    w8, #15, lsl #16
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">12</span>      add     x9, sp, #4
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">13</span>      add     x10, sp, #8
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">14</span> LBB0_1:                                 ; =&gt;This Inner Loop Header: Depth=1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">15</span>      ldr     s1, [x0], #4
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">16</span>      ldr     s2, [x1], #4
<span style="display:inline-block;width:100%;white-space:pre;background-color:rgba(0, 255, 4, 0.49);border-radius:2px;"><span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">17</span>      fmadd   s1, s0, s1, s2</span>
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">18</span>      str     s1, [sp, #4]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">19</span>      str     x9, [sp, #8]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">20</span>      ; InlineAsm Start
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">21</span>      ; InlineAsm End
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">22</span>      subs    x8, x8, #1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">23</span>      b.ne    LBB0_1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">24</span> ; bb.2:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">25</span>      add     sp, sp, #16
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">26</span>      ret
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">27</span>      .cfi_endproc
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">28</span>                                         ; -- End function
</code></pre><p><br  />
</p>
<p>Further inspection reveals the Fused-Multiply-Add instruction &ndash; indicating that SAXPY operation was not optimized away. </p><pre><code class="language-asm">
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">17</span>      fmadd   s0, s0, s1, s2
</code></pre><p><a href="https://developer.arm.com/documentation/ddi0602/2025-06/SIMD-FP-Instructions/FMADD--Floating-point-fused-multiply-add--scalar--">Reference to Arm A64 Instruction Set: <b>FMADD</b></a></p>
<h3>5.2. On x86_64</h3>
<p>Compiled with <span class="tt">g++ (GCC) 15.1.0</span> on <span class="tt">x86_64 Intel(R) Xeon(R) Platinum 8468</span>                  </p>
<p>Full x86_64 Assembly code of <code><a class="el" href="_do_not_optimize__demo_8cpp.html#a0b3e578501d76859fa31815d0c3b9ef9">SAXPY_DONOTOPTIMIZE()</a></code> with <code>-O3</code> optimization </p><pre><code class="language-asm">
    <span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">6</span> _Z19SAXPY_DONOTOPTIMIZEfPKfS0_:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">7</span> .LFB1:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">8</span>       .cfi_startproc
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">9</span>       movaps  xmm0, xmm1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">10</span>      xorl    eax, eax
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">11</span>      .p2align 4
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">12</span>      .p2align 3
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">13</span> .L2:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">14</span>      movss   (rdi,rax), xmm0
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">15</span>      leaq    -4(rsp), rdx
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">16</span>      movq    rdx, -24(rsp)
<span style="display:inline-block;width:100%;white-space:pre;background-color:rgba(0, 255, 4, 0.49);border-radius:2px;"><span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">17</span>      mulss   xmm1, xmm0
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">18</span>      addss   (rsi,rax), xmm0</span>
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">19</span>      movss   xmm0, -4(rsp)
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">20</span>      addq    $4, rax
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">21</span>      cmpq    $4000000, rax
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">22</span>      jne     .L2
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">23</span>      ret
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">24</span>      .cfi_endproc
   
</code></pre><p>Again, further inspection shows that SAXPY operation is not optimized out. </p><pre><code class="language-asm">
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">17</span>      mulss   -20(rbp), xmm1 
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">18</span>      addss   xmm1, xmm0
</code></pre><p>Intel® 64 and IA-32 Architectures Software Developer’s Manual Volume 2 (2A, 2B, 2C, &amp; 2D): Instruction Set Reference, A–Z: Vol. 2B, 4-151, <b>MULSS — Multiply Scalar Single Precision Floating-Point Values</b>. Vol. 2A, 3-24 , <b>ADDSS—Add Scalar Single Precision Floating-Point Values</b>.</p>
<hr  />
 <h4>5.2.1. Conclusion &ndash; <span class="tt"><a class="el" href="saxpy___do_not_optimize_8cpp.html#a4800adc1dfab08974da980d447c594ea">DoNotOptimize()</a></span> works!</h4>
<p>Code can still be optimized while keeping the operation. Next section will examine how does it work.</p>
<hr  />
<h2>6. Inspecting <span class="tt"><a class="el" href="saxpy___do_not_optimize_8cpp.html#a4800adc1dfab08974da980d447c594ea">DoNotOptimize()</a></span></h2>
<p>We can define DoNotOptimize minimally as: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="saxpy___do_not_optimize_8cpp.html#a4800adc1dfab08974da980d447c594ea">DoNotOptimize</a>(<span class="keywordtype">void</span> * p)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;+m,r&quot;</span>(p) : : <span class="stringliteral">&quot;memory&quot;</span>);</div>
<div class="line">}</div>
</div><!-- fragment --> <hr  />
 <h3>6.1. Breakdown 1: Assembly</h3>
<p><span class="tt"><a class="el" href="saxpy___do_not_optimize_8cpp.html#a4800adc1dfab08974da980d447c594ea">DoNotOptimize()</a></span> is an extended assembly code, the GNU documentation on <a href="https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html"><em>Extended asm</em></a>:</p>
<div class="fragment"><div class="line">asm asm-qualifiers ( AssemblerTemplate </div>
<div class="line">                 : OutputOperands </div>
<div class="line">                 [ : InputOperands</div>
<div class="line">                 [ : Clobbers ] ])</div>
</div><!-- fragment --><ul>
<li><b>AssemblerTemplate</b> is the assembly code/instructions.</li>
<li><b>OutputOperands</b> are the outputs back into C/C++.</li>
<li><b>InputOperands</b> are the inputs from C/C++.</li>
<li><b>Clobbers</b> list what this asm code modifies.</li>
</ul>
<h3>6.2. Breakdown 2: Meaning of this asm code</h3>
<ul>
<li><b>AssemblerTemplate</b> is empty: <span class="tt">""</span> — no actual instructions execute.</li>
<li><p class="startli"><b>OutputOperands</b>:</p><ul>
<li><span class="tt">"+"</span> is a <a href="https://gcc.gnu.org/onlinedocs/gcc/Modifiers.html#Constraint-Modifier-Characters">Constraint Modifier Character</a> indicating read <em>and</em> write by the asm.</li>
<li><span class="tt">"m"</span> is a <a href="https://gcc.gnu.org/onlinedocs/gcc/Simple-Constraints.html#Simple-Constraints-1">Simple Constraint</a> meaning the operand can be in main memory.</li>
<li><span class="tt">"r"</span> is also a <a href="https://gcc.gnu.org/onlinedocs/gcc/Simple-Constraints.html#Simple-Constraints-1">Simple Constraint</a> meaning the operand can be in register memory.</li>
<li><span class="tt">"m,r"</span> provides <a href="https://gcc.gnu.org/onlinedocs/gcc/Multi-Alternative.html#Multiple-Alternative-Constraints">Multiple Alternatives</a>: the operand may be in main memory <b>or</b> register memory.</li>
</ul>
<p class="startli"><b>Combined:</b> <span class="tt">"+m,r"</span> means “treat <span class="tt">p</span> as read and written ("+"), where <span class="tt">p</span> is located either in main memory ("m") or a register("r").”</p>
</li>
<li><b>InputOperands</b>: none (the read/write behavior is implied by the output constraint).</li>
<li><b>Clobbers</b>: <span class="tt">"memory"</span> — indicates the asm may change memory, acting as a read/write memory barrier.</li>
</ul>
<p>Putting it together: &gt;“Read and write the memory location <span class="tt">p</span> (OutputOperands "+m,r"), with possible memory effects (Clobbers "memory"), with no actual operation (AssemblerTemplate "")”</p>
<h3>6.3. Breakdown 3: <span class="tt">volatile</span></h3>
<p>The <span class="tt">volatile</span> asm-qualifier (see <a href="https://gcc.gnu.org/onlinedocs/gcc/Extended-Asm.html#Volatile-1">GNU Extended Asm — Volatile</a>) tells the compiler this asm block has important side effects. Without it, an optimizer could decide the output is unused and delete the asm — and, transitively, the memory location <span class="tt">p</span>. With <span class="tt">volatile</span>, the compiler must preserve the asm and thus the memory location <span class="tt">p</span>.</p>
<h3>6.4. Conclusion</h3>
<p>This asm line means:</p>
<blockquote class="doxtable">
<p>“This memory location <span class="tt">p</span> is read and written (<span class="tt">+m,r</span>), with observable effects on memory (<span class="tt">"memory"</span> clobber). Because the asm is <span class="tt">volatile</span>, you must not optimize away the variable or this operation.” </p>
</blockquote>
<hr  />
<h3>6.5. <span class="tt"><a class="el" href="saxpy___do_not_optimize_8cpp.html#a4800adc1dfab08974da980d447c594ea">DoNotOptimize()</a></span> in practice</h3>
<p>In practice, <span class="tt"><a class="el" href="saxpy___do_not_optimize_8cpp.html#a4800adc1dfab08974da980d447c594ea">DoNotOptimize()</a></span> accepts any object type; the idea is the same:</p>
<div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keyword">inline</span> __attribute__((always_inline)) <span class="keywordtype">void</span> <a class="code hl_function" href="saxpy___do_not_optimize_8cpp.html#a4800adc1dfab08974da980d447c594ea">DoNotOptimize</a>(T <span class="keyword">const</span> &amp;value)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;&quot;</span> : : <span class="stringliteral">&quot;r,m&quot;</span>(value) : <span class="stringliteral">&quot;memory&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keyword">inline</span> __attribute__((always_inline)) <span class="keywordtype">void</span> <a class="code hl_function" href="saxpy___do_not_optimize_8cpp.html#a4800adc1dfab08974da980d447c594ea">DoNotOptimize</a>(T &amp;value)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;+m,r&quot;</span>(value) : : <span class="stringliteral">&quot;memory&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keyword">inline</span> __attribute__((always_inline)) <span class="keywordtype">void</span> <a class="code hl_function" href="saxpy___do_not_optimize_8cpp.html#a4800adc1dfab08974da980d447c594ea">DoNotOptimize</a>(T &amp;&amp;value)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">asm</span> <span class="keyword">volatile</span>(<span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;+m,r&quot;</span>(value) : : <span class="stringliteral">&quot;memory&quot;</span>);</div>
<div class="line">}</div>
</div><!-- fragment --><h2>7. Example Case</h2>
<p>Referring back to the example case, some behaviours can be observed.</p>
<h3>7.1. Example Source Code</h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="_do_not_optimize__demo_8cpp.html#aa5b565b3eee10d362eab37bebfbd199e">SAXPY</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> a, <span class="keyword">const</span> <span class="keywordtype">float</span>* x, <span class="keyword">const</span> <span class="keywordtype">float</span>* y)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">float</span> yout;</div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a03adebee29527207e43a1b362d77fe65">HOTLOOPSTART</a>;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code hl_define" href="manual__timing__demo_8cpp.html#a0240ac851181b84ac374872dc5434ee4">N</a>; ++i)</div>
<div class="line">    {</div>
<div class="line">        yout = a * x[i] + y[i];</div>
<div class="line">    }</div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a3f983d0c821f40a98683debcc90a1e97">HOTLOOPEND</a>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="_do_not_optimize__demo_8cpp.html#a0b3e578501d76859fa31815d0c3b9ef9">SAXPY_DONOTOPTIMIZE</a>(<span class="keyword">const</span> <span class="keywordtype">float</span> a, <span class="keyword">const</span> <span class="keywordtype">float</span>* x, <span class="keyword">const</span> <span class="keywordtype">float</span>* y)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">float</span> yout;</div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a03adebee29527207e43a1b362d77fe65">HOTLOOPSTART</a>;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code hl_define" href="manual__timing__demo_8cpp.html#a0240ac851181b84ac374872dc5434ee4">N</a>; ++i)</div>
<div class="line">    {</div>
<div class="line">        yout = a * x[i] + y[i];</div>
<div class="line">        <a class="code hl_function" href="namespacecomppare.html#a047cefc5aebc47d079d502c2d189fe12">comppare::DoNotOptimize</a>(yout);</div>
<div class="line">    }</div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a3f983d0c821f40a98683debcc90a1e97">HOTLOOPEND</a>;</div>
<div class="line">}</div>
<div class="ttc" id="acomppare_8hpp_html_a03adebee29527207e43a1b362d77fe65"><div class="ttname"><a href="comppare_8hpp.html#a03adebee29527207e43a1b362d77fe65">HOTLOOPSTART</a></div><div class="ttdeci">#define HOTLOOPSTART</div><div class="ttdoc">Macro to mark the start of a hot loop for benchmarking. This macro defines a lambda function hotloop_...</div><div class="ttdef"><b>Definition</b> comppare.hpp:846</div></div>
<div class="ttc" id="acomppare_8hpp_html_a3f983d0c821f40a98683debcc90a1e97"><div class="ttname"><a href="comppare_8hpp.html#a3f983d0c821f40a98683debcc90a1e97">HOTLOOPEND</a></div><div class="ttdeci">#define HOTLOOPEND</div><div class="ttdef"><b>Definition</b> comppare.hpp:872</div></div>
<div class="ttc" id="anamespacecomppare_html_a047cefc5aebc47d079d502c2d189fe12"><div class="ttname"><a href="namespacecomppare.html#a047cefc5aebc47d079d502c2d189fe12">comppare::DoNotOptimize</a></div><div class="ttdeci">void DoNotOptimize(T const &amp;value)</div><div class="ttdoc">Prevents the compiler from optimizing away the given value.</div><div class="ttdef"><b>Definition</b> comppare.hpp:100</div></div>
</div><!-- fragment --><h3>7.2. "Performance" difference</h3>
<div class="fragment"><div class="line">Implementation             Func µs/Iter        ROI µs/Iter       Ovhd µs/Iter</div>
<div class="line">SAXPY                               0.00                0.00                0.00</div>
<div class="line">SAXPY_DONOTOPTIMIZE                57.14               28.60               28.54</div>
</div><!-- fragment --><p> From the discussion above, the performance difference is actually due to <span class="tt">SAXPY</span> being an empty function, while <span class="tt">SAXPY_DONOTOPTIMIZE</span> actually computes the operation.</p>
<h3>7.3. Compiler Warning</h3>
<p>The build step also compiles <span class="tt"><a class="el" href="saxpy_8cpp.html">saxpy.cpp</a></span> and <span class="tt"><a class="el" href="saxpy___do_not_optimize_8cpp.html">saxpy_DoNotOptimize.cpp</a></span> into their respected assembly codes in <span class="tt">build/asm/</span>.</p>
<hr  />
<p>There is a compiler warning for <span class="tt"><a class="el" href="saxpy_8cpp.html">saxpy.cpp</a></span>: </p><div class="fragment"><div class="line">/path/to/ComPPare/examples/advanced_demo/4-DoNotOptimize/saxpy.cpp: In function ‘void SAXPY(float, const float*, const float*)’:</div>
<div class="line">/path/to/ComPPare/examples/advanced_demo/4-DoNotOptimize/saxpy.cpp:5:11: warning: variable ‘yout’ set but not used [-Wunused-but-set-variable]</div>
<div class="line">    5 |     float yout;</div>
<div class="line">      |           ^~~~</div>
</div><!-- fragment --><p> Which shows that the compiler identifies <span class="tt">yout</span> as a variable that is not needed, thus optimized away.</p>
<hr  />
<p>For <span class="tt"><a class="el" href="saxpy___do_not_optimize_8cpp.html">saxpy_DoNotOptimize.cpp</a></span>, there is no such warning, which shows that the compiler is being tricked by <span class="tt"><a class="el" href="saxpy___do_not_optimize_8cpp.html#a4800adc1dfab08974da980d447c594ea">DoNotOptimize()</a></span> that <span class="tt">yout</span> is being used and thus not optimized away.</p>
<h3>7.4. Inspection of the full asm code</h3>
<p><span class="tt">build/asm/DoNotOptimize_demo.s</span> is the full asm code of the benchmark</p>
<h4>7.4.1. On AArch64 (Apple M2)</h4>
<p>To look for SAXPY operations, based on findings in <a class="el" href="/Users/stanleyfungleongfan/Documents/GitHub/ComPPare/examples/advanced_demo/4-DoNotOptimize/README.md#saxpyappleM2isa">Just don't Optimize -- ARM FMADD</a>, we can find whether <span class="tt">fmadd</span> exists by:</p>
<div class="fragment"><div class="line">grep -rnw fmadd build/asm/DoNotOptimize_demo.s </div>
</div><!-- fragment --><p><b>Results in:</b> </p><div class="fragment"><div class="line">build/asm/DoNotOptimize_demo.s:86:      fmadd   s0, s8, s0, s1</div>
<div class="line">build/asm/DoNotOptimize_demo.s:116:     fmadd   s0, s8, s0, s1</div>
</div><!-- fragment --><p>It resulted in 2 <span class="tt">fmadd</span>, this is due to extra code being "injected" via the ComPPare framework. The first <span class="tt">fmadd</span> at line 86 is the warmup runs, while line 116 is the actual benchmark runs.</p>
<p>It can be further validated when inspecting the function SAXPY_DONOTOPTIMIZE in asm</p>
<details >
<summary >
AArch64 Assembly of <code>SAXPY_DONOTOPTIMIZE()</code> function within the benchmark </summary>
<pre><code class="language-asm">
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">45</span> __Z19SAXPY_DONOTOPTIMIZEfPKfS0_:        ; @_Z19SAXPY_DONOTOPTIMIZEfPKfS0_
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">46</span>      .cfi_startproc
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">47</span> ; bb.0:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">48</span>      sub     sp, sp, #80
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">49</span>      .cfi_def_cfa_offset 80
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">50</span>      stp     d9, d8, [sp, #16]               ; 16-byte Folded Spill
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">51</span>      stp     x22, x21, [sp, #32]             ; 16-byte Folded Spill
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">52</span>      stp     x20, x19, [sp, #48]             ; 16-byte Folded Spill
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">53</span>      stp     x29, x30, [sp, #64]             ; 16-byte Folded Spill
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">54</span>      add     x29, sp, #64
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">55</span>      .cfi_def_cfa w29, 16
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">56</span>      .cfi_offset w30, -8
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">57</span>      .cfi_offset w29, -16
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">58</span>      .cfi_offset w19, -24
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">59</span>      .cfi_offset w20, -32
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">60</span>      .cfi_offset w21, -40
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">61</span>      .cfi_offset w22, -48
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">62</span>      .cfi_offset b8, -56
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">63</span>      .cfi_offset b9, -64
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">64</span>      mov     x19, x1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">65</span>      mov     x20, x0
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">66</span>      fmov    s8, s0
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">67</span> Lloh2:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">68</span>      adrp    x22, __ZZN8comppare6config8instanceEvE4inst@GOTPAGE
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">69</span> Lloh3:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">70</span>      ldr     x22, [x22, __ZZN8comppare6config8instanceEvE4inst@GOTPAGEOFF]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">71</span>      ldr     x8, [x22, #8]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">72</span>      cbz     x8, LBB1_5
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">73</span> ; bb.1:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">74</span>      mov     x8, #0
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">75</span>      add     x9, sp, #12
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">76</span> LBB1_2:                                 ; =&gt;This Loop Header: Depth=1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">77</span>                                         ;     Child Loop BB1_3 Depth 2
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">78</span>      mov     x10, x20
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">79</span>      mov     x11, x19
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">80</span>      mov     w12, #34464
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">81</span>      movk    w12, #1, lsl #16
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">82</span> LBB1_3:                                 ;   Parent Loop BB1_2 Depth=1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">83</span>                                         ; =&gt;  This Inner Loop Header: Depth=2
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">84</span>      ldr     s0, [x10], #4
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">85</span>      ldr     s1, [x11], #4
<span style="display:inline-block;width:100%;white-space:pre;background-color:rgba(0, 255, 4, 0.49);border-radius:2px;"><span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">86</span>      fmadd   s0, s8, s0, s1</span>
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">87</span>      str     s0, [sp, #12]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">88</span>      ; InlineAsm Start
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">89</span>      ; InlineAsm End
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">90</span>      subs    x12, x12, #1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">91</span>      b.ne    LBB1_3
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">92</span> ; bb.4:                                ;   in Loop: Header=BB1_2 Depth=1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">93</span>      add     x8, x8, #1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">94</span>      ldr     x10, [x22, #8]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">95</span>      cmp     x8, x10
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">96</span>      b.lo    LBB1_2
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">97</span> LBB1_5:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">98</span>      str     xzr, [x22]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">99</span>      bl      __ZNSt3__16chrono12steady_clock3nowEv
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">100</span>     mov     x21, x0
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">101</span>     ldr     x8, [x22, #16]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">102</span>     cbz     x8, LBB1_10
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">103</span> ; bb.6:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">104</span>     mov     x8, #0
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">105</span>     add     x9, sp, #12
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">106</span> LBB1_7:                                 ; =&gt;This Loop Header: Depth=1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">107</span>                                         ;     Child Loop BB1_8 Depth 2
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">108</span>     mov     x10, x20
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">109</span>     mov     x11, x19
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">110</span>     mov     w12, #34464
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">111</span>     movk    w12, #1, lsl #16
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">112</span> LBB1_8:                                 ;   Parent Loop BB1_7 Depth=1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">113</span>                                         ; =&gt;  This Inner Loop Header: Depth=2
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">114</span>     ldr     s0, [x10], #4
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">115</span>     ldr     s1, [x11], #4
<span style="display:inline-block;width:100%;white-space:pre;background-color:rgba(0, 255, 4, 0.49);border-radius:2px;"><span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">116</span>     fmadd   s0, s8, s0, s1</span>
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">117</span>     str     s0, [sp, #12]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">118</span>     ; InlineAsm Start
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">119</span>     ; InlineAsm End
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">120</span>     subs    x12, x12, #1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">121</span>     b.ne    LBB1_8
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">122</span> ; bb.9:                                ;   in Loop: Header=BB1_7 Depth=1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">123</span>     add     x8, x8, #1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">124</span>     ldr     x10, [x22, #16]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">125</span>     cmp     x8, x10
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">126</span>     b.lo    LBB1_7
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">127</span> LBB1_10:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">128</span>     bl      __ZNSt3__16chrono12steady_clock3nowEv
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">129</span>     ldr     d0, [x22]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">130</span>     fcmp    d0, #0.0
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">131</span>     b.ne    LBB1_12
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">132</span> ; bb.11:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">133</span>     sub     x8, x0, x21
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">134</span>     scvtf   d0, x8
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">135</span>     mov     x8, #70368744177664
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">136</span>     movk    x8, #16527, lsl #48
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">137</span>     fmov    d1, x8
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">138</span>     fdiv    d0, d0, d1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">139</span>     str     d0, [x22]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">140</span> LBB1_12:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">141</span>     ldp     x29, x30, [sp, #64]             ; 16-byte Folded Reload
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">142</span>     ldp     x20, x19, [sp, #48]             ; 16-byte Folded Reload
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">143</span>     ldp     x22, x21, [sp, #32]             ; 16-byte Folded Reload
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">144</span>     ldp     d9, d8, [sp, #16]               ; 16-byte Folded Reload
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">145</span>     add     sp, sp, #80
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">146</span>     ret
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">147</span>     .loh AdrpLdrGot Lloh2, Lloh3
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">148</span>     .cfi_endproc
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">149</span>                                         ; -- End function
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">150</span>     .globl  _main                           ; -- Begin function main
</code></pre> </details>
<h4>7.4.2. On x86_64</h4>
<p>To look for SAXPY operations, based on findings in <a class="el" href="/Users/stanleyfungleongfan/Documents/GitHub/ComPPare/examples/advanced_demo/4-DoNotOptimize/README.md#saxpy_x86_isa">Just don't Optimize -- x86 MULSS ADDSS</a>, we can find whether <span class="tt">mulss</span> and <span class="tt">addss</span> exists by:</p>
<div class="fragment"><div class="line">grep -rnw mulss build/asm/DoNotOptimize_demo.s</div>
<div class="line">grep -rnw addss build/asm/DoNotOptimize_demo.s</div>
</div><!-- fragment --><p><b>Results in:</b> </p><div class="fragment"><div class="line">build/asm/DoNotOptimize_demo.s:258:    mulss   %xmm0, %xmm1</div>
<div class="line">build/asm/DoNotOptimize_demo.s:282:    mulss   %xmm0, %xmm1</div>
<div class="line">build/asm/DoNotOptimize_demo.s:259:    addss   (%r12,%rax), %xmm1</div>
<div class="line">build/asm/DoNotOptimize_demo.s:283:    addss   (%r12,%rax), %xmm1</div>
</div><!-- fragment --><p>Again, the doubling of both <span class="tt">mulss</span> and <span class="tt">addss</span> is due to warmup runs and benchmark runs.</p>
<details >
<summary >
x86_64 Assembly of <code>SAXPY_DONOTOPTIMIZE()</code> function within the benchmark </summary>
<pre><code class="language-asm">
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">232</span> _Z19SAXPY_DONOTOPTIMIZEfPKfS0_:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">233</span> .LFB7449:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">234</span>     .cfi_startproc
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">235</span>     pushq   rbp
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">236</span>     .cfi_def_cfa_offset 16
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">237</span>     .cfi_offset 6, -16
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">238</span>     xorl    ecx, ecx
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">239</span>     movq    rsp, rbp
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">240</span>     .cfi_def_cfa_register 6
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">241</span>     pushq   r13
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">242</span>     pushq   r12
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">243</span>     .cfi_offset 13, -24
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">244</span>     .cfi_offset 12, -32
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">245</span>     movq    rsi, r12
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">246</span>     pushq   rbx
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">247</span>     .cfi_offset 3, -40
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">248</span>     movq    rdi, rbx
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">249</span>     subq    $24, rsp
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">250</span>     cmpq    $0, _ZZN8comppare6config8instanceEvE4inst+8(rip)
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">251</span>     je      .L36
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">252</span> .L35:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">253</span>     xorl    eax, eax
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">254</span>     .p2align 4,,10
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">255</span>     .p2align 3
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">256</span> .L37:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">257</span>     movss   (rbx,rax), xmm1
<span style="display:inline-block;width:100%;white-space:pre;background-color:rgba(0, 255, 4, 0.49);border-radius:2px;"><span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">258</span>     mulss   xmm0, xmm1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">259</span>     addss   (r12,rax), xmm1</span>
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">260</span>     movd    xmm1, edx
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">261</span>     addq    $4, rax
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">262</span>     cmpq    $400000, rax
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">263</span>     jne     .L37
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">264</span>     addq    $1, rcx
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">265</span>     cmpq    _ZZN8comppare6config8instanceEvE4inst+8(rip), rcx
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">266</span>     jb      .L35
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">267</span> .L36:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">268</span>     movss   xmm0, -36(rbp)
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">269</span>     movq    $0x000000000, _ZZN8comppare6config8instanceEvE4inst(rip)
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">270</span>     call    _ZNSt6chrono3_V212steady_clock3nowEv
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">271</span>     xorl    ecx, ecx
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">272</span>     cmpq    $0, _ZZN8comppare6config8instanceEvE4inst+16(rip)
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">273</span>     movss   -36(rbp), xmm0
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">274</span>     movq    rax, r13
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">275</span>     je      .L39
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">276</span> .L38:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">277</span>     xorl    eax, eax
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">278</span>     .p2align 4,,10
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">279</span>     .p2align 3
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">280</span> .L40:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">281</span>     movss   (rbx,rax), xmm1
<span style="display:inline-block;width:100%;white-space:pre;background-color:rgba(0, 255, 4, 0.49);border-radius:2px;"><span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">282</span>     mulss   xmm0, xmm1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">283</span>     addss   (r12,rax), xmm1</span>
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">284</span>     movd    xmm1, edx
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">285</span>     addq    $4, rax
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">286</span>     cmpq    $400000, rax
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">287</span>     jne     .L40
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">288</span>     addq    $1, rcx
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">289</span>     cmpq    _ZZN8comppare6config8instanceEvE4inst+16(rip), rcx
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">290</span>     jb      .L38
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">291</span> .L39:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">292</span>     call    _ZNSt6chrono3_V212steady_clock3nowEv
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">293</span>     pxor    xmm0, xmm0
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">294</span>     ucomisd _ZZN8comppare6config8instanceEvE4inst(rip), xmm0
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">295</span>     jp      .L34
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">296</span>     jne     .L34
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">297</span>     subq    r13, rax
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">298</span>     pxor    xmm0, xmm0
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">299</span>     cvtsi2sdq       rax, xmm0
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">300</span>     divsd   .LC1(rip), xmm0
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">301</span>     movsd   xmm0, _ZZN8comppare6config8instanceEvE4inst(rip)
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">302</span> .L34:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">303</span>     addq    $24, rsp
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">304</span>     popq    rbx
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">305</span>     popq    r12
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">306</span>     popq    r13
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">307</span>     popq    rbp
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">308</span>     .cfi_def_cfa 7, 8
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">309</span>     ret
</code></pre> </details>
</div><!-- contents -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a href="dir_d28a4824dc47e487b107a5db32ef43c4.html">examples</a></li><li class="navelem"><a href="dir_cd43f9252faa2edaded5e402af091fd1.html">advanced_demo</a></li><li class="navelem"><a href="dir_14e75ca7720201dcafdfda602efa671a.html">4-DoNotOptimize</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
