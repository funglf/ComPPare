<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ComPPare: examples/max_reduction Directory Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ComPPare<span id="projectnumber">&#160;1.0.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('dir_8d4c8d310e3b52dbd1209e3ee14d5b48.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">max_reduction Directory Reference</div></div>
</div><!--header-->
<div class="contents">
<div class="dynheader">
Directory dependency graph for max_reduction:</div>
<div class="dyncontent">
<div class="center"><iframe scrolling="no" loading="lazy" frameborder="0" src="dir_8d4c8d310e3b52dbd1209e3ee14d5b48_dep.svg" width="160" height="158"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div>
</div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 id="header-files" class="groupheader"><a id="files" name="files"></a>
Files</h2></td></tr>
<tr class="memitem:init_5Fmax_2Ecpp" id="r_init_5Fmax_2Ecpp"><td class="memItemLeft" align="right" valign="top"><span class="icondoc"><div class="doc-icon"></div></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="init__max_8cpp.html">init_max.cpp</a></td></tr>
<tr class="memitem:init_5Fmax_2Ehpp" id="r_init_5Fmax_2Ehpp"><td class="memItemLeft" align="right" valign="top"><a href="init__max_8hpp_source.html"><span class="icondoc"><div class="doc-icon"></div></span></a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="init__max_8hpp.html">init_max.hpp</a></td></tr>
<tr class="memitem:main_2Ecpp" id="r_main_2Ecpp"><td class="memItemLeft" align="right" valign="top"><span class="icondoc"><div class="doc-icon"></div></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="max__reduction_2main_8cpp.html">main.cpp</a></td></tr>
<tr class="memitem:max_5Fcpu_2Ecpp" id="r_max_5Fcpu_2Ecpp"><td class="memItemLeft" align="right" valign="top"><span class="icondoc"><div class="doc-icon"></div></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="max__cpu_8cpp.html">max_cpu.cpp</a></td></tr>
<tr class="memitem:max_5Fcpu_2Ehpp" id="r_max_5Fcpu_2Ehpp"><td class="memItemLeft" align="right" valign="top"><a href="max__cpu_8hpp_source.html"><span class="icondoc"><div class="doc-icon"></div></span></a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="max__cpu_8hpp.html">max_cpu.hpp</a></td></tr>
</table>
<a name="details" id="details"></a><h2 id="header-details" class="groupheader">Detailed Description</h2>
<p>Finds the maximum value within an array/vector.</p>
<ul>
<li>1. Build Instructions<ul>
<li>1.1. Dependencies</li>
</ul>
</li>
<li>2. Run the Benchmark</li>
<li>3. Implementation of ComPPare in this example<ul>
<li>3.1. Basic Usage of `HOTLOOP` macro</li>
<li>3.2. Manual Timing</li>
<li>3.3. Use of Pointer with `std::span`</li>
<li>3.4. ComPPare in `main()`</li>
</ul>
</li>
</ul>
<h1>1. Build Instructions</h1>
<h2>1.1. Dependencies</h2>
<ul>
<li>CMake</li>
<li>C++20 compatible compiler</li>
<li>For GPU kernel build:<ul>
<li>NVIDIA nvcc compiler wrapper</li>
</ul>
</li>
</ul>
<hr  />
<h2>1.1.2. GPU Build </h2>
<div class="fragment"><div class="line">mkdir build &amp;&amp; cd build</div>
<div class="line"> </div>
<div class="line">cmake \</div>
<div class="line">    -DCMAKE_BUILD_TYPE=Release \</div>
<div class="line">    -DUSE_CUDA=ON \</div>
<div class="line">    ..</div>
<div class="line"> </div>
<div class="line">make</div>
</div><!-- fragment --><h3>1.1.2.1. Optional GPU build option </h3>
<div class="fragment"><div class="line">cmake \</div>
<div class="line">    -DCMAKE_BUILD_TYPE=Release \</div>
<div class="line">    -DUSE_CUDA=ON \</div>
<div class="line">    -DCUDA_ARCH=90 \ #Optional: Specify CUDA Architecture </div>
<div class="line">    ..</div>
</div><!-- fragment --><h2>1.1.3. CPU only Build (default) </h2>
<div class="fragment"><div class="line">mkdir build &amp;&amp; cd build</div>
<div class="line">cmake ..</div>
<div class="line">make</div>
</div><!-- fragment --><p>Or explicitly:</p>
<div class="fragment"><div class="line">mkdir build &amp;&amp; cd build</div>
<div class="line"> </div>
<div class="line">cmake \</div>
<div class="line">    -DCMAKE_BUILD_TYPE=Release \</div>
<div class="line">    -DUSE_CUDA=OFF \</div>
<div class="line">    ..</div>
<div class="line"> </div>
<div class="line">make</div>
</div><!-- fragment --><p>Only CPU backends (serial and parallel) will be built.</p>
<hr  />
<h1>2. Run the Benchmark</h1>
<p>The executable takes the following command-line arguments:</p>
<h2>1.2.1. Arguments </h2>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Flag  </th><th class="markdownTableHeadNone">Description  </th><th class="markdownTableHeadNone">Default  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><span class="tt">--size</span>  </td><td class="markdownTableBodyNone">log2 of vector size (<span class="tt">N = 2^n</span>)  </td><td class="markdownTableBodyNone">18  </td></tr>
</table>
<h2>1.2.2. Example </h2>
<div class="fragment"><div class="line">./max_reduction --size 26</div>
</div><!-- fragment --><h2>1.2.3. Output Example </h2>
<p>Output will print:</p>
<ul>
<li>Function execution time</li>
<li>Core compute time (isolated)</li>
<li>Overhead (e.g., memory copies)</li>
<li>Error of Max Val against reference</li>
</ul>
<hr  />
<div class="fragment"><div class="line">=== Max Reduction Benchmark Parameters ===</div>
<div class="line">Vector size (N)     : 67108864</div>
<div class="line">===================================</div>
<div class="line"> </div>
<div class="line">*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=</div>
<div class="line">============ ComPPare Framework ============</div>
<div class="line">=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*</div>
<div class="line"> </div>
<div class="line">Number of implementations:             5</div>
<div class="line">Warmup iterations:                   100</div>
<div class="line">Benchmark iterations:                100</div>
<div class="line">=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*</div>
<div class="line"> </div>
<div class="line">Implementation                  Func µs             ROI µs            Ovhd µs       Total|err|[0]</div>
<div class="line">cpu serial                      36303.95            17437.95            18866.00            0.00e+00</div>
<div class="line">cpu omp                        107208.48            62084.54            45123.94            0.00e+00</div>
<div class="line">cpu thread                      44459.22            21151.77            23307.45            0.00e+00</div>
<div class="line">gpu kernel                     133597.43            32933.28           100664.15            0.00e+00</div>
<div class="line">gpu kernel opt                 109846.87            20369.54            89477.33            0.00e+00</div>
</div><!-- fragment --><h1>3. Implementation of ComPPare in this example</h1>
<h2>3.1. Basic Usage of <span class="tt">HOTLOOP</span> macro</h2>
<p>Adding <span class="tt">HOTLOOPSTART</span> and <span class="tt">HOTLOOPEND</span> macros to the region you want to benchmark. It will run the region with certain iterations of warmup (default=100) before running another certain number of iterations for benchmark (default=100).</p>
<div class="fragment"><div class="line"><span class="comment">// max_cpu.cpp</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="max__cpu_8cpp.html#ada2f04938f2dea02a36ed954bfc7d3d6">cpu_max_serial</a>(std::span&lt;const float&gt; in, <span class="keywordtype">float</span> &amp;out)</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a03adebee29527207e43a1b362d77fe65">HOTLOOPSTART</a>;   <span class="comment">// Start of Region you want to benchmark</span></div>
<div class="line">    out = *std::max_element(in.data(), in.data() + in.size());</div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a3f983d0c821f40a98683debcc90a1e97">HOTLOOPEND</a>;     <span class="comment">// End of Region you want to benchmark</span></div>
<div class="line">}</div>
<div class="ttc" id="acomppare_8hpp_html_a03adebee29527207e43a1b362d77fe65"><div class="ttname"><a href="comppare_8hpp.html#a03adebee29527207e43a1b362d77fe65">HOTLOOPSTART</a></div><div class="ttdeci">#define HOTLOOPSTART</div><div class="ttdoc">Macro to mark the start of a hot loop for benchmarking. This macro defines a lambda function hotloop_...</div><div class="ttdef"><b>Definition</b> comppare.hpp:846</div></div>
<div class="ttc" id="acomppare_8hpp_html_a3f983d0c821f40a98683debcc90a1e97"><div class="ttname"><a href="comppare_8hpp.html#a3f983d0c821f40a98683debcc90a1e97">HOTLOOPEND</a></div><div class="ttdeci">#define HOTLOOPEND</div><div class="ttdef"><b>Definition</b> comppare.hpp:872</div></div>
<div class="ttc" id="amax__cpu_8cpp_html_ada2f04938f2dea02a36ed954bfc7d3d6"><div class="ttname"><a href="max__cpu_8cpp.html#ada2f04938f2dea02a36ed954bfc7d3d6">cpu_max_serial</a></div><div class="ttdeci">void cpu_max_serial(std::span&lt; const float &gt; in, float &amp;out)</div><div class="ttdef"><b>Definition</b> max_cpu.cpp:13</div></div>
</div><!-- fragment --><h2>3.2. Manual Timing</h2>
<h3>Reduction on GPUs </h3>
<p>In GPU, operations are executed in units of thread-blocks. Each block contains a number of threads, and a grid (a number of) of blocks are launched.</p>
<p>In reduction, each block is reponsible for a portion of the whole array. After each block reduces, it returns the local maximum. As there are multiple blocks, it forms an output array of local maxima, or a partially reduced output. Therefore, we take this partial reduced output and do reduction again until there is only 1 value, which is our global maximum.</p>
<p>Below is a graphical explanation of reduction on GPU: &lt;style&gt; .diagram { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; line-height: 1.35; } .h { font-weight: 800; letter-spacing: .02em; } .note { color: #444; } .swapptr{ color: #6a1b9a; font-weight: 700; } .b0 { color:#e53935; } /* * */ .b1 { color:#222222; } /* • */ .b2 { color:#1e88e5; } /* o */ .b3 { color:#43a047; } /* x */ .b4 { color:#fb8c00; } /* + */ .dim { color:#777; } .hr { margin: 8px 0; border-bottom: 1px dashed #bbb; } .pad { margin: 6px 0; } &lt;/style&gt;</p>
<div class="diagram"> <div class="pad"><span class="h">Legend:</span> [B0] <span class="b0">*</span> &#160; [B1] <span class="b1">•</span> &#160; [B2] <span class="b2">o</span> &#160; [B3] <span class="b3">x</span> &#160; [B4] <span class="b4">+</span> &#160; &#160; [B#] denotes a thread block. </div></div><div class="diagram"> <div class="hr"></div></div><div class="diagram"> <div class="pad h">— ONE REDUCTION ITERATION —</div></div><div class="diagram"> <pre>
<b>INPUT</b>  (<code>d_input</code>, N elements; grouped by blocks of size <code>BLOCKSIZE</code>) [B0] <span class="b0">*</span> <span class="b0">*</span> <span class="b0">*</span> <span class="b0">*</span> <span class="b0">*</span> <span class="b0">*</span> <span class="b0">*</span> <span class="b0">*</span> | [B1] <span class="b1">•</span> <span class="b1">•</span> <span class="b1">•</span> <span class="b1">•</span> <span class="b1">•</span> <span class="b1">•</span> <span class="b1">•</span> <span class="b1">•</span> | [B2] <span class="b2">o</span> <span class="b2">o</span> <span class="b2">o</span> <span class="b2">o</span> <span class="b2">o</span> <span class="b2">o</span> <span class="b2">o</span> <span class="b2">o</span> | [B3] <span class="b3">x</span> <span class="b3">x</span> <span class="b3">x</span> <span class="b3">x</span> <span class="b3">x</span> <span class="b3">x</span> <span class="b3">x</span> <span class="b3">x</span> | … │ │ │ │ v v v v <b>OUTPUT</b> (<code>d_output</code>, one per block = N/BLOCKSIZE) <span class="b0">*</span> <span class="b1">•</span> <span class="b2">o</span> <span class="b3">x</span> … </pre></div><div class="diagram"> <div class="note">Each block reduces its chunk → <b>one block-maximum</b> goes to <code>d_output</code>.</div></div><div class="diagram"> <div class="pad"><span class="swapptr">SWAP POINTERS:</span> <code>d_input</code> ↔ <code>d_output</code> &#160; <span class="dim">Now the block maxima are the next iteration’s input, so the partial result can be further reduced.</span></div></div><div class="diagram"> <div class="hr"></div></div><div class="diagram"> <div class="pad h">— NEXT ITERATION —</div></div><div class="diagram"> <pre>
<b>INPUT</b>  (<code>d_input</code>, N/BLOCKSIZE; previous iteration's partially reduced output) [G0] <span class="b0">*</span> <span class="b1">•</span> <span class="b2">o</span> <span class="b3">x</span> <span class="b4">+</span> <span class="b0">*</span> <span class="b1">•</span> <span class="b2">o</span> | [G1] <span class="b3">x</span> <span class="b4">+</span> <span class="b0">*</span> <span class="b1">•</span> <span class="b2">o</span> <span class="b3">x</span> <span class="b4">+</span> <span class="b0">*</span> | … │ │ │ v v v <b>OUTPUT</b> (<code>d_output</code>, one per block = ⌈N/BLOCKSIZE²⌉) <span class="b0">*</span> <span class="b3">x</span> … </pre></div><div class="diagram"> <div class="pad"><b>Repeat until only one value remains &ndash; global maximum</b>.</div><p> <br  />
<br  />
 </div><h3>Benchmarking GPU Reduction </h3>
<p>As shown, input and output arrays are used interchangably in the reduction operation for read and writes. Hence, the original array is no longer avaliable in device memory. Therefore, we would need to copy the original array back into device memory before each iteration. This is memory transfer overhead we would avoid benchmarking, as we want to know the performance of the kernel itself.</p>
<p>To limit to certain regions to benchmark, there are macros provided <span class="tt">START_MANUAL_TIMER</span> and <span class="tt">STOP_MANUAL_TIMER</span> to specify the actual region of interest, and ignoring any overhead within the loop.</p>
<p>As for GPU code, macros <span class="tt">GPU_START_MANUAL_TIMER</span> and <span class="tt">GPU_STOP_MANUAL_TIMER</span> are used instead to time the device but not host cpu.</p>
<p>Hence, our GPU host code looks like: </p><div class="fragment"><div class="line"><span class="comment">// max_gpu.cu</span></div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keywordtype">void</span> (*KERNEL)(const <span class="keywordtype">int</span>, <span class="keywordtype">float</span> *__restrict__, const <span class="keywordtype">float</span> *__restrict__)&gt;</div>
<div class="line"><span class="keywordtype">void</span> gpu_max(std::span&lt;const float&gt; in, <span class="keywordtype">float</span> &amp;out)</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line"> </div>
<div class="line">    GPU_HOTLOOPSTART;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Mem copy of Original Array to Device -- Required in each loop */</span></div>
<div class="line"> </div>
<div class="line">    GPU_START_MANUAL_TIMER;</div>
<div class="line">    <span class="comment">/* Parallel Reduction on GPU */</span></div>
<div class="line">    GPU_STOP_MANUAL_TIMER;</div>
<div class="line"> </div>
<div class="line">    GPU_HOTLOOPEND;</div>
<div class="line"> </div>
<div class="line">    ...</div>
<div class="line">}</div>
</div><!-- fragment --><h2>3.3. Use of Pointer with <span class="tt">std::span</span></h2>
<p>In this code, the data is essentially a pointer to a raw array. However, the framework would not be able to compare raw arrays as the size is unknown. How can we solve this?</p>
<h3><span class="tt">std::span</span> </h3>
<p>Since C++20, <span class="tt">std::span</span> is avaliable which acts as a wrapper over raw pointers.</p>
<p>It stores the pointer to the array and the size of the array. Therefore, size would be known and the framework will be able to automatically compare the arrays.</p>
<p><b>Essentially, std::span can be defined minimally:</b> </p><div class="fragment"><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</div>
<div class="line"><span class="keyword">struct </span>span</div>
<div class="line">{</div>
<div class="line">    T* pointer_to_array;</div>
<div class="line">    std::size_t size_of_array;</div>
<div class="line">}</div>
</div><!-- fragment --><p> <b>How to use std::span:</b> </p><div class="fragment"><div class="line">std::size_t array_size = 10;</div>
<div class="line"><span class="keywordtype">int</span>* array = <span class="keyword">new</span> <span class="keywordtype">int</span>[array_size];</div>
<div class="line">std::span&lt;int&gt; wrapped_array = std::span&lt;int&gt;(array, array_size);</div>
</div><!-- fragment --><h2>3.4. ComPPare in <span class="tt"><a class="el" href="dummy_2main_8cpp.html#ae66f6b31b5ad750f1fe042a706a4e3d4">main()</a></span></h2>
<p>First create the the instance of comppare by providing the input type(s) in InputContext (<span class="tt">std::span&lt;const float&gt;</span> in this case) and the output type(s) in OutputContext (<span class="tt">float</span> in this case). Then initialize the instance with input data. </p><div class="fragment"><div class="line">comppare::</div>
<div class="line">        InputContext&lt;std::span&lt;const float&gt;&gt;::</div>
<div class="line">            OutputContext&lt;float&gt;</div>
<div class="line">                compare(<span class="comment">/*type: std::span&lt;const float&gt;*/</span>input_data);</div>
</div><!-- fragment --><p>Set Reference function and add other functions for comparison </p><div class="fragment"><div class="line"><span class="comment">// Set reference implementation</span></div>
<div class="line">compare.set_reference(<span class="stringliteral">&quot;cpu serial&quot;</span>, <a class="code hl_function" href="max__cpu_8cpp.html#ada2f04938f2dea02a36ed954bfc7d3d6">cpu_max_serial</a>);</div>
<div class="line"><span class="comment">// Add implementations to compare</span></div>
<div class="line">compare.add(<span class="stringliteral">&quot;cpu omp&quot;</span>, <a class="code hl_function" href="max__cpu_8cpp.html#a9fef4e1759a92151e7afbdc25f671fdd">cpu_max_omp</a>);</div>
<div class="ttc" id="amax__cpu_8cpp_html_a9fef4e1759a92151e7afbdc25f671fdd"><div class="ttname"><a href="max__cpu_8cpp.html#a9fef4e1759a92151e7afbdc25f671fdd">cpu_max_omp</a></div><div class="ttdeci">void cpu_max_omp(std::span&lt; const float &gt; in, float &amp;out)</div><div class="ttdef"><b>Definition</b> max_cpu.cpp:20</div></div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a href="dir_d28a4824dc47e487b107a5db32ef43c4.html">examples</a></li><li class="navelem"><a href="dir_8d4c8d310e3b52dbd1209e3ee14d5b48.html">max_reduction</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
