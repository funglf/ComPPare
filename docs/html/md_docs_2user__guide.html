<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ComPPare: User Guide ComPPare &ndash; Validation &amp; Benchmarking Framework &lt;!-- omit from toc --&gt;</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ComPPare<span id="projectnumber">&#160;1.0.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md_docs_2user__guide.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">User Guide ComPPare &ndash; Validation &amp; Benchmarking Framework  </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li>1. Getting Started<ul>
<li>1.1. Install</li>
<li>1.2. Basic Usage</li>
<li>1.3. Basic Working Principle</li>
</ul>
</li>
<li>2. User API Documentation<ul>
<li>2.1. Macros</li>
<li>2.2. ComPPare `main()`</li>
<li>2.3. Google Benchmark Plugin</li>
<li>2.4. `DoNotOptimize()`</li>
</ul>
</li>
</ul>
<h1>1. Getting Started</h1>
<h2>1.1. Install</h2>
<h3>1.1.1. Clone repository </h3>
<div class="fragment"><div class="line">git clone git@github.com:funglf/ComPPare.git --recursive</div>
</div><!-- fragment --> <h4>If submodules like google benchmark/ nvbench is not needed: </h4>
<div class="fragment"><div class="line">git clone git@github.com:funglf/ComPPare.git</div>
</div><!-- fragment --><h3>1.1.2. (Optional) Build Google Benchmark </h3>
<p>See <a href="https://github.com/google/benchmark/blob/b20cea674170b2ba45da0dfaf03953cdea473d0d/README.md">Google Benchmark Instructions</a></p>
<h3>1.1.3. Include ComPPare </h3>
<p>In your C++ code, simply include the comppare header file by: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="comppare_8hpp.html">comppare/comppare.hpp</a>&gt;</span></div>
<div class="ttc" id="acomppare_8hpp_html"><div class="ttname"><a href="comppare_8hpp.html">comppare.hpp</a></div><div class="ttdoc">This file is the main include file for the ComPPare framework.</div></div>
</div><!-- fragment --><h2>1.2. Basic Usage</h2>
<p>There are a few rules in order to use comppare.</p>
<h3>1.2.1. Adopt the required function signature </h3>
<p><em>Function output must be <span class="tt">void</span></em> and consists of the input, then output types </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> impl(<span class="keyword">const</span> Inputs&amp;... in,     <span class="comment">// read‑only inputs</span></div>
<div class="line">        Outputs&amp;...      out);     <span class="comment">// outputs compared to reference</span></div>
</div><!-- fragment --><h3>1.2.2. Add <span class="tt">HOTLOOP</span> Macros </h3>
<p>In order to benchmark specific regions of code, following Macros <span class="tt">HOTLOOPSTART</span>, <span class="tt">HOTLOOPEND</span> are needed. The region in between will be ran multiple times in order to get an accurate timing. The region first runs certain iterations of warmup before actually running the benchmark iterations.</p>
<h4>How to use <span class="tt">HOTLOOPSTART</span>/<span class="tt">HOTLOOPEND</span> Macros </h4>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> impl(<span class="keyword">const</span> Inputs&amp;... in,</div>
<div class="line">        Outputs&amp;...      out);</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* </span></div>
<div class="line"><span class="comment">    setup or overhead you DO NOT want to benchmark </span></div>
<div class="line"><span class="comment">    -- memory allocation, data transfer, etc.</span></div>
<div class="line"><span class="comment">    */</span></div>
<div class="line"> </div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a03adebee29527207e43a1b362d77fe65">HOTLOOPSTART</a>; <span class="comment">// Macro of start of Benchmarking Region of Interest</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// ... perform core computation here ...</span></div>
<div class="line"> </div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a3f983d0c821f40a98683debcc90a1e97">HOTLOOPEND</a>;   <span class="comment">// Macro of end of Benchmarking Region of Interest</span></div>
<div class="line">}</div>
<div class="ttc" id="acomppare_8hpp_html_a03adebee29527207e43a1b362d77fe65"><div class="ttname"><a href="comppare_8hpp.html#a03adebee29527207e43a1b362d77fe65">HOTLOOPSTART</a></div><div class="ttdeci">#define HOTLOOPSTART</div><div class="ttdoc">Macro to mark the start of a hot loop for benchmarking. This macro defines a lambda function hotloop_...</div><div class="ttdef"><b>Definition</b> comppare.hpp:858</div></div>
<div class="ttc" id="acomppare_8hpp_html_a3f983d0c821f40a98683debcc90a1e97"><div class="ttname"><a href="comppare_8hpp.html#a3f983d0c821f40a98683debcc90a1e97">HOTLOOPEND</a></div><div class="ttdeci">#define HOTLOOPEND</div><div class="ttdef"><b>Definition</b> comppare.hpp:884</div></div>
</div><!-- fragment --><h4>Alternate Macro </h4>
<p>Alternatively, the macro <span class="tt"><a class="el" href="comppare_8hpp.html#a171973717bfe2c264acae42f9e1ad486" title="Macro to wrap a code block for benchmarking.">HOTLOOP()</a></span> can be used to wrap the whole region. </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> impl(<span class="keyword">const</span> Inputs&amp;... in,</div>
<div class="line">        Outputs&amp;...      out);</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a171973717bfe2c264acae42f9e1ad486">HOTLOOP</a>(</div>
<div class="line">    <span class="comment">// ... perform core computation here ...</span></div>
<div class="line">    );</div>
<div class="line">}</div>
<div class="ttc" id="acomppare_8hpp_html_a171973717bfe2c264acae42f9e1ad486"><div class="ttname"><a href="comppare_8hpp.html#a171973717bfe2c264acae42f9e1ad486">HOTLOOP</a></div><div class="ttdeci">#define HOTLOOP(LOOP_BODY)</div><div class="ttdoc">Macro to wrap a code block for benchmarking.</div><div class="ttdef"><b>Definition</b> comppare.hpp:907</div></div>
</div><!-- fragment --><h3>1.2.3. Setting up Comparison in <span class="tt">main()</span> </h3>
<p>In <span class="tt">main()</span>, you can setup the comparison, such as defining the reference function, initializing input data, naming of benchmark etc.</p>
<blockquote class="doxtable">
<p>### The SAXPY example will be used throughout this section to demonstrate on usage &gt;<b>SAXPY</b> stands for <b>Single-Precision A·X Plus Y</b>. (Also see examples/saxpy)</p>
<p>It stands for the following operation:</p>
<p>&gt;$$ &gt;y_{\text{out}}[i] = a \cdot x[i] + y[i] &gt;$$ </p>
</blockquote>
<p>Based on Section [Basic Usage], we can define a <span class="tt">saxpy</span> function as: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> saxpy_cpu(<span class="comment">/*Input types*/</span></div>
<div class="line">               <span class="keywordtype">float</span> a,</div>
<div class="line">               <span class="keyword">const</span> std::vector&lt;float&gt; &amp;x,</div>
<div class="line">               <span class="keyword">const</span> std::vector&lt;float&gt; &amp;y_in,</div>
<div class="line">               <span class="comment">/*Output types*/</span></div>
<div class="line">               std::vector&lt;float&gt; &amp;y_out)</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a03adebee29527207e43a1b362d77fe65">HOTLOOPSTART</a>;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0; i &lt; x.size(); ++i)</div>
<div class="line">        y_out[i] = a * x[i] + y_in[i];</div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a3f983d0c821f40a98683debcc90a1e97">HOTLOOPEND</a>;</div>
<div class="line">}</div>
</div><!-- fragment --> <hr  />
 <h4>Step 1: Initialize Input data </h4>
<div class="fragment"><div class="line"><span class="comment">/* Intialize Input data */</span></div>
<div class="line"><span class="keywordtype">float</span> a = 1.1f</div>
<div class="line">std::vector x(1000, 1.0); </div>
<div class="line">std::vector y_in(1000, 2.0);</div>
</div><!-- fragment --> <hr  />
 <h4>Step 2: Create a Comparison Object </h4>
<p>This step defines the input and output types of the functions you are about to test.</p>
<p>For <span class="tt">saxpy_cpu</span>, the <b>input types</b> are: </p><div class="fragment"><div class="line"><span class="comment">/* INPUTS: */</span></div>
<div class="line">float,</div>
<div class="line">std::vector&lt;float&gt;,</div>
<div class="line">std::vector&lt;float&gt;</div>
</div><!-- fragment --><p>Let's define an alias here based on the Input Types: </p><div class="fragment"><div class="line"><span class="keyword">using </span>CMP_INPUT = <a class="code hl_namespace" href="namespacecomppare.html">comppare</a>::</div>
<div class="line">    <span class="comment">/*Define Input Pack Types same as the function*/</span></div>
<div class="line">    InputContext&lt;</div>
<div class="line">                    float,              <span class="comment">/*float a*/</span></div>
<div class="line">                    std::vector&lt;float&gt;, <span class="comment">/*std::vector&lt;float&gt; x*/</span></div>
<div class="line">                    std::vector&lt;float&gt;  <span class="comment">/*std::vector&lt;float&gt; y*/</span></div>
<div class="line">                &gt;::</div>
<div class="ttc" id="anamespacecomppare_html"><div class="ttname"><a href="namespacecomppare.html">comppare</a></div><div class="ttdoc">ComPPare framework main namespace.</div></div>
</div><!-- fragment --><hr  />
<p>As for the <b>output types</b>: </p><div class="fragment"><div class="line"><span class="comment">/* OUTPUTS: */</span></div>
<div class="line">std::vector&lt;float&gt;</div>
</div><!-- fragment --><p> Let's define another alias based on the Output Types: </p><div class="fragment"><div class="line"><span class="keyword">using </span>CMP = CMP_INPUT::</div>
<div class="line">    <span class="comment">/*Define Output Pack types same as the function*/</span></div>
<div class="line">    OutputContext&lt;</div>
<div class="line">                    std::vector&lt;float&gt;  <span class="comment">/*std::vector&lt;float&gt; y_out*/</span></div>
<div class="line">                 &gt;;</div>
</div><!-- fragment --><hr  />
<p>Finally, we can create our comparison object with the alias <span class="tt">CMP</span> and initialize with the input data: </p><div class="fragment"><div class="line">CMP cmp(a,x,y_in); <span class="comment">// Input data initialized above</span></div>
</div><!-- fragment --><hr  />
<p> <b>Or, define all at once without alias:</b></p>
<p>Therefore, we can define the comparison object as: </p><div class="fragment"><div class="line"><a class="code hl_namespace" href="namespacecomppare.html">comppare</a>:: <span class="comment">/*namespace comppare*/</span></div>
<div class="line">    <span class="comment">/*Define Input Pack Types same as the function*/</span></div>
<div class="line">    InputContext&lt;</div>
<div class="line">                    float,              <span class="comment">/*float a*/</span></div>
<div class="line">                    std::vector&lt;float&gt;, <span class="comment">/*std::vector&lt;float&gt; x*/</span></div>
<div class="line">                    std::vector&lt;float&gt;  <span class="comment">/*std::vector&lt;float&gt; y*/</span></div>
<div class="line">                &gt;::</div>
<div class="line">    <span class="comment">/*Define Output Pack types same as the function*/</span></div>
<div class="line">    OutputContext&lt;</div>
<div class="line">                    std::vector&lt;float&gt;  <span class="comment">/*std::vector&lt;float&gt; y_out*/</span></div>
<div class="line">                 &gt;;</div>
<div class="line">    </div>
<div class="line">    cmp(a,x,y_in);   <span class="comment">//cmp object -- a,x,y data</span></div>
</div><!-- fragment --><h4>Step 3: Register/Add Functions into framework </h4>
<p>After creating the <span class="tt">cmp</span> object, we can add functions into it.</p>
<p>To Define the reference function: </p><div class="fragment"><div class="line">cmp.set_reference(<span class="comment">/*Displayed Name After Benchmark*/</span><span class="stringliteral">&quot;saxpy reference&quot;</span>, <span class="comment">/*Function*/</span>saxpy_cpu);</div>
</div><!-- fragment --><p>To Add more fucntions: </p><div class="fragment"><div class="line">cmp.add(<span class="stringliteral">&quot;saxpy gpu&quot;</span>, saxpy_gpu);</div>
</div><!-- fragment --><h4>Step 4: Run the Benchmarks </h4>
<p>Command line arguments are the parameters for run(): </p><div class="fragment"><div class="line">cmp.run(argc, argv);</div>
</div><!-- fragment --><h4>Step 5: Results </h4>
<p>Example Output: </p><div class="fragment"><div class="line">*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=</div>
<div class="line">============ ComPPare Framework ============</div>
<div class="line">=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*</div>
<div class="line"> </div>
<div class="line">Number of implementations:             3</div>
<div class="line">Warmup iterations:                   100</div>
<div class="line">Benchmark iterations:                100</div>
<div class="line">=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*</div>
<div class="line"> </div>
<div class="line">Implementation                  Func µs             ROI µs            Ovhd µs         Max|err|[0]        Mean|err|[0]       Total|err|[0]</div>
<div class="line">saxpy reference                    38.01               15.97               22.05            0.00e+00            0.00e+00            0.00e+00</div>
<div class="line">saxpy gpu                       73151.41                1.07            73150.34            3.30e+06            1.66e+06            1.70e+09  &lt;-- FAIL</div>
</div><!-- fragment --><p> In this case, <span class="tt">saxpy_gpu</span> failed.</p>
<h3>1.2.4. Command Line Options &ndash; Iterations </h3>
<p>There are 2 commmand line options to control the number of warmup and benchmark iterations:</p>
<h4><span class="tt">--warmups</span> Warmup Iterations </h4>
<p>When used with a unsigned 64 bit integer, this sets the number of warmup iterations before running benchmark runs.</p>
<p>Example: </p><div class="fragment"><div class="line">./saxpy --warmups 1000</div>
</div><!-- fragment --><h4><span class="tt">--iters</span> Benchmark Iterations </h4>
<p>When used with a unsigned 64 bit integer, this sets the number of benchmark iterations</p>
<p>Example: </p><div class="fragment"><div class="line">./saxpy --iters 1000</div>
</div><!-- fragment --><h2>1.3. Basic Working Principle</h2>
<h3>1.3.1. <span class="tt">HOTLOOP</span> Macros </h3>
<p>HOTLOOP Macros essentially wrap your region of interest in a lambda before running the lambda across the warmup and benchmark iterations. The region of iterest is being timed across all the benchmark iterations to obtain an average runtime.</p>
<p>In <span class="tt"><a class="el" href="comppare_8hpp.html" title="This file is the main include file for the ComPPare framework.">comppare/comppare.hpp</a></span>, <span class="tt">HOTLOOPSTART</span> and <span class="tt">HOTLOOPEND</span> are defined as: </p><div class="fragment"><div class="line"><span class="preprocessor">#define HOTLOOPSTART \</span></div>
<div class="line"><span class="preprocessor">    auto &amp;&amp;hotloop_body = [&amp;]() { </span><span class="comment">/* start of lambda */</span><span class="preprocessor"></span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define HOTLOOPEND     \</span></div>
<div class="line"><span class="preprocessor">    }; </span><span class="comment">/* end lambda */</span><span class="preprocessor"> \</span></div>
</div><!-- fragment --><p>Therefore, any code in between the 2 macros are simply wrapped into the lambda <span class="tt">hotloop_body</span>: </p><div class="fragment"><div class="line"><a class="code hl_define" href="comppare_8hpp.html#a03adebee29527207e43a1b362d77fe65">HOTLOOPSTART</a>;</div>
<div class="line">foo();</div>
<div class="line"><a class="code hl_define" href="comppare_8hpp.html#a3f983d0c821f40a98683debcc90a1e97">HOTLOOPEND</a>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* is equivalent to */</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">auto</span> &amp;&amp;hotloop_body = [&amp;]() {</div>
<div class="line">    foo();</div>
<div class="line">};</div>
</div><!-- fragment --><p>After that, the lambda is being ran: </p><div class="fragment"><div class="line"><span class="comment">/* Warm-up */</span>                                                      </div>
<div class="line"><span class="keywordflow">for</span> (i = 0; i &lt; warmup_iterations; ++i) </div>
<div class="line">    hotloop_body();                                                </div>
<div class="line">                </div>
<div class="line"><span class="comment">/* Benchmark */</span></div>
<div class="line"><span class="keyword">auto</span> start = now();                        </div>
<div class="line"><span class="keywordflow">for</span> (i = 0; i &lt; benchmark_iterations; ++i)  </div>
<div class="line">    hotloop_body();                                                </div>
<div class="line"><span class="keyword">auto</span> end = now();                        </div>
</div><!-- fragment --><h3>1.3.2. Output Comparison </h3>
<p>Each implementation follows the same signature: </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> impl(<span class="keyword">const</span> Inputs&amp;... in,     <span class="comment">// read‑only inputs</span></div>
<div class="line">        Outputs&amp;...      out);     <span class="comment">// outputs compared to reference</span></div>
</div><!-- fragment --><p> <b>Input</b> – Passed in by the framework. All candidates get exactly the same data.</p>
<p><b>Output</b> – The framework creates private output objects and passes into the implementation by reference. Therefore any change in the object will be stored in the framework.</p>
<p>After each implementation has finished running, the framework compares each output against the reference implementation, and prints out the results in terms of difference/error and whether it has failed.</p>
<h1>2. User API Documentation</h1>
<h2>2.1. Macros</h2>
<h3>2.1.1 hotloop Macros </h3>
<h4><span class="tt">HOTLOOPSTART</span> &amp; <span class="tt">HOTLOOPEND</span> </h4>
<p>Used to wrap around region of <b>CPU functions/operations</b> for framework to benchmark</p>
<p>example: </p><div class="fragment"><div class="line">impl(...)</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a03adebee29527207e43a1b362d77fe65">HOTLOOPSTART</a>;</div>
<div class="line">    cpu_func();</div>
<div class="line">    a+b;</div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a3f983d0c821f40a98683debcc90a1e97">HOTLOOPEND</a>;</div>
<div class="line">}</div>
</div><!-- fragment --> <h4><span class="tt"><a class="el" href="comppare_8hpp.html#a171973717bfe2c264acae42f9e1ad486" title="Macro to wrap a code block for benchmarking.">HOTLOOP()</a></span> </h4>
<p>Alternative of HOTLOOPSTART/END</p>
<p>example: </p><div class="fragment"><div class="line">impl(...)</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a171973717bfe2c264acae42f9e1ad486">HOTLOOP</a>(</div>
<div class="line">    cpu_func();</div>
<div class="line">    a+b;</div>
<div class="line">    );</div>
<div class="line">}</div>
</div><!-- fragment --> <h4><span class="tt">GPU_HOTLOOPSTART</span> &amp; <span class="tt">GPU_HOTLOOPEND</span> </h4>
<p>Host Macro to wrap around region of <b>GPU host functions/operations</b> for framework to benchmark. Supports both CUDA and HIP, provided that the host function is compiled with the respected CUDA-compiler-wrapper <span class="tt">nvcc</span> and HIP-compiler-wrapper <span class="tt">hipcc</span></p>
<blockquote class="doxtable">
<p><b>Warning</b> Do Not use this within GPU kernels. </p>
</blockquote>
<p>example: </p><div class="fragment"><div class="line">gpu_impl(...)</div>
<div class="line">{</div>
<div class="line">    GPU_HOTLOOPSTART;</div>
<div class="line">    kernel&lt;&lt;&lt;...&gt;&gt;&gt;(...)</div>
<div class="line">    cudaMemcpy(...);</div>
<div class="line">    GPU_HOTLOOPEND;</div>
<div class="line">}</div>
</div><!-- fragment --> <h4><span class="tt">GPU_HOTLOOP()</span> </h4>
<p>Alternative of GPU_HOTLOOPSTART/END</p>
<p>example: </p><div class="fragment"><div class="line">gpu_impl(...)</div>
<div class="line">{</div>
<div class="line">    GPU_HOTLOOP(</div>
<div class="line">    kernel&lt;&lt;&lt;...&gt;&gt;&gt;(...)</div>
<div class="line">    cudaMemcpy(...);</div>
<div class="line">    );</div>
<div class="line">}</div>
</div><!-- fragment --><h3>2.1.2 Manual timer Macros </h3>
<h4><span class="tt">MANUAL_TIMER_START</span> &amp; <span class="tt">MANUAL_TIMER_END</span> </h4>
<p>Used to wrap around region of CPU functions/operations <b>within HOTLOOP</b></p>
<blockquote class="doxtable">
<p>These set of macros can <b>ONLY be used once</b> within the Hotloop </p>
</blockquote>
<p>Example &ndash; Only times <span class="tt">a+b</span>: </p><div class="fragment"><div class="line">impl(...)</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a03adebee29527207e43a1b362d77fe65">HOTLOOPSTART</a>;</div>
<div class="line">    cpu_func();</div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a09770669e2181c6a712ea4512ded4e36">MANUAL_TIMER_START</a></div>
<div class="line">    a+b;</div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a6cde3e9e2e72f32aeb69aba4a09f353f">MANUAL_TIMER_END</a></div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a3f983d0c821f40a98683debcc90a1e97">HOTLOOPEND</a>;</div>
<div class="line">}</div>
<div class="ttc" id="acomppare_8hpp_html_a09770669e2181c6a712ea4512ded4e36"><div class="ttname"><a href="comppare_8hpp.html#a09770669e2181c6a712ea4512ded4e36">MANUAL_TIMER_START</a></div><div class="ttdeci">#define MANUAL_TIMER_START</div><div class="ttdoc">Macro to mark the start of a manual timer for benchmarking.</div><div class="ttdef"><b>Definition</b> comppare.hpp:913</div></div>
<div class="ttc" id="acomppare_8hpp_html_a6cde3e9e2e72f32aeb69aba4a09f353f"><div class="ttname"><a href="comppare_8hpp.html#a6cde3e9e2e72f32aeb69aba4a09f353f">MANUAL_TIMER_END</a></div><div class="ttdeci">#define MANUAL_TIMER_END</div><div class="ttdoc">Macro to mark the end of a manual timer for benchmarking.</div><div class="ttdef"><b>Definition</b> comppare.hpp:919</div></div>
</div><!-- fragment --><h4><span class="tt">GPU_MANUAL_TIMER_START</span> &amp; <span class="tt">GPU_MANUAL_TIMER_END</span> </h4>
<p>Used to wrap around region of GPU host functions/operations <b>within HOTLOOP</b>. Supports both CUDA and HIP, provided that the host function is compiled with the respected CUDA-compiler-wrapper <span class="tt">nvcc</span> and HIP-compiler-wrapper <span class="tt">hipcc</span></p>
<blockquote class="doxtable">
<p>These set of macros can <b>ONLY be used once</b> within the Hotloop </p>
</blockquote>
<p>Example &ndash; Only times kernel: </p><div class="fragment"><div class="line">gpu_impl(...)</div>
<div class="line">{</div>
<div class="line">    GPU_HOTLOOPSTART;</div>
<div class="line">    GPU_MANUAL_TIMER_START;</div>
<div class="line">    kernel&lt;&lt;&lt;...&gt;&gt;&gt;(...)</div>
<div class="line">    GPU_MANUAL_TIMER_END;</div>
<div class="line">    cudaMemcpy(...);</div>
<div class="line">    GPU_HOTLOOPEND;</div>
<div class="line">}</div>
</div><!-- fragment --><h3>2.1.3 Custom iteration timer Macro </h3>
<h4><span class="tt"><a class="el" href="comppare_8hpp.html#a8293881eb66cf6e561c6533b3af71ea1">SET_ITERATION_TIME(us)</a></span> </h4>
<p>This Macro takes in a **floating point number representing time of current iteration in $\mu s$**</p>
<p>Example on mixed timers: </p><div class="fragment"><div class="line">mixed_impl(...)</div>
<div class="line">{</div>
<div class="line">    cudaEvent_t gpu_start, gpu_end;</div>
<div class="line">    cudaEventCreate(&amp;gpu_start);              \</div>
<div class="line">    cudaEventCreate(&amp;gpu_end);</div>
<div class="line"> </div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a03adebee29527207e43a1b362d77fe65">HOTLOOPSTART</a>;</div>
<div class="line">    <span class="comment">/* Timing CPU region of cpu_func() only*/</span></div>
<div class="line">    <span class="keyword">auto</span> cpu_start = chrono::steady_clock::now();</div>
<div class="line">    cpu_func();</div>
<div class="line">    <span class="keyword">auto</span> cpu_end = chrono::steady_clock::now();</div>
<div class="line">    a+b</div>
<div class="line">    <span class="comment">/* Microseconds taken by cpu_func() */</span></div>
<div class="line">    <span class="keywordtype">float</span> cpu_us = std::chrono::duration&lt;float, std::micro&gt;(end - start).count();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Timing GPU region of kernel only */</span></div>
<div class="line">    cudaEventRecord(gpu_start);</div>
<div class="line">    kernel&lt;&lt;&lt;...&gt;&gt;&gt;(...)</div>
<div class="line">    cudaEventRecord(gpu_end);</div>
<div class="line">    cudaMemcpy(...);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Microseconds taken by gpu kernel */</span></div>
<div class="line">    <span class="keywordtype">float</span> gpu_ms;</div>
<div class="line">    cudaEventElapsedTime(&amp;ms_manual, gpu_start, gpu_end);</div>
<div class="line">    <span class="keywordtype">float</span> gpu_us = gpu_ms * 1e3;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* set the total iteration time in us */</span></div>
<div class="line">    <span class="keywordtype">float</span> total_iteration_us = cpu_us + gpu_us;</div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a8293881eb66cf6e561c6533b3af71ea1">SET_ITERATION_TIME</a>(total_iteration_us);</div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a3f983d0c821f40a98683debcc90a1e97">HOTLOOPEND</a>;</div>
<div class="line">}</div>
<div class="ttc" id="acomppare_8hpp_html_a8293881eb66cf6e561c6533b3af71ea1"><div class="ttname"><a href="comppare_8hpp.html#a8293881eb66cf6e561c6533b3af71ea1">SET_ITERATION_TIME</a></div><div class="ttdeci">#define SET_ITERATION_TIME(TIME)</div><div class="ttdef"><b>Definition</b> comppare.hpp:924</div></div>
</div><!-- fragment --><h2>2.2. ComPPare <span class="tt">main()</span></h2>
<h3>2.2.1. Creating the ComPPare object </h3>
<p>Given your implementation signature:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> impl(<span class="keyword">const</span> Inputs&amp;... in,</div>
<div class="line">          Outputs&amp;...      out);</div>
</div><!-- fragment --><p>Instantiate the comparison context by forwarding the input arguments into the nested <span class="tt">OutputContext</span> constructor:</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="classcomppare_1_1_input_context.html">comppare::InputContext</a>&lt;Inputs...&gt;</div>
<div class="line">          ::OutputContext&lt;Outputs...&gt; </div>
<div class="line">            cmp(in...);</div>
<div class="ttc" id="aclasscomppare_1_1_input_context_html"><div class="ttname"><a href="classcomppare_1_1_input_context.html">comppare::InputContext</a></div><div class="ttdoc">InputContext class template to hold input parameters for the comparison framework.</div><div class="ttdef"><b>Definition</b> comppare.hpp:193</div></div>
</div><!-- fragment --><ul>
<li><b><span class="tt">Inputs...</span></b> Variadic template parameters corresponding to the <b>types</b> of the input arguments of <span class="tt">impl</span> (e.g. <span class="tt">float</span>, <span class="tt">std::vector&lt;int&gt;</span>, etc.).</li>
<li><b><span class="tt">Outputs...</span></b> Variadic template parameters corresponding to the <b>types</b> of the output arguments of <span class="tt">impl</span>.</li>
</ul>
<p>The order of <span class="tt">Inputs...</span> and <span class="tt">Outputs...</span> must match the order in the <span class="tt">impl</span> signature. After construction, <span class="tt">cmp</span> is ready to have implementations registered (via <span class="tt">set_reference</span> / <span class="tt">add</span>) and executed (via <span class="tt">run</span>).</p>
<h3>2.2.2. Setting Implementations for Framework </h3>
<h4><span class="tt">set_reference</span> </h4>
<p>Registers the “reference” implementation and returns its corresponding <span class="tt">Impl</span> descriptor for further configuration &ndash; eg attaching to Plugins like Google Benchmark.</p>
<h5>Context </h5>
<p>Member of</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="classcomppare_1_1_input_context.html">comppare::InputContext</a>&lt;Inputs...&gt;::OutputContext&lt;Outputs...&gt;</div>
</div><!-- fragment --><h5>Signature </h5>
<div class="fragment"><div class="line">comppare::Impl&amp; set_reference(</div>
<div class="line">    std::string display_name,</div>
<div class="line">    std::function&lt;<span class="keywordtype">void</span>(<span class="keyword">const</span> Inputs&amp;... , Outputs&amp;...)&gt; f</div>
<div class="line">);</div>
</div><!-- fragment --><h5>Parameters </h5>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Name  </th><th class="markdownTableHeadNone">Type  </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><span class="tt">display_name</span>  </td><td class="markdownTableBodyNone"><span class="tt">std::string</span>  </td><td class="markdownTableBodyNone">Human-readable label for this reference implementation. Used in output report.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><span class="tt">f</span>  </td><td class="markdownTableBodyNone"><span class="tt">std::function&lt;void(const Inputs&amp;... , Outputs&amp;...)&gt;</span>  </td><td class="markdownTableBodyNone">Function matching the signature: <span class="tt">void(const Inputs&amp;... in, Outputs&amp;... out)</span>  </td></tr>
</table>
<h5>Returns </h5>
<ul>
<li><p class="startli"><b><span class="tt">comppare::Impl&amp;</span></b></p>
<p class="startli">Reference to the internal <span class="tt">Impl</span> object representing the just-registered implementation. Used mainly for attaching to plugins like Google Benchmark.</p>
<p class="startli">Recommended to discard return value.</p>
</li>
</ul>
<h5>Example </h5>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> ref_impl(<span class="keyword">const</span> Inputs&amp;..., Outputs...){};</div>
<div class="line"><span class="keyword">auto</span> cmp = <a class="code hl_class" href="classcomppare_1_1_input_context.html">comppare::InputContext</a>&lt;Inputs...&gt;::OutputContext&lt;Outputs...&gt;();</div>
<div class="line"> </div>
<div class="line">cmp.set_reference(<span class="comment">/*display name*/</span><span class="stringliteral">&quot;reference implementation&quot;</span>, <span class="comment">/*function*/</span> ref_impl);</div>
</div><!-- fragment --><hr  />
 <h4><span class="tt">add</span> </h4>
<p>Registers additional implementation which will be compared against reference and returns its corresponding <span class="tt">Impl</span> descriptor for further configuration &ndash; eg attaching to Plugins like Google Benchmark.</p>
<h5>Context </h5>
<p>Member of</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="classcomppare_1_1_input_context.html">comppare::InputContext</a>&lt;Inputs...&gt;::OutputContext&lt;Outputs...&gt;</div>
</div><!-- fragment --><h5>Signature </h5>
<div class="fragment"><div class="line">comppare::Impl&amp; add(</div>
<div class="line">    std::string display_name,</div>
<div class="line">    std::function&lt;<span class="keywordtype">void</span>(<span class="keyword">const</span> Inputs&amp;... , Outputs&amp;...)&gt; f</div>
<div class="line">);</div>
</div><!-- fragment --><h5>Parameters </h5>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Name  </th><th class="markdownTableHeadNone">Type  </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><span class="tt">display_name</span>  </td><td class="markdownTableBodyNone"><span class="tt">std::string</span>  </td><td class="markdownTableBodyNone">Human-readable label for this reference implementation. Used in output report.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><span class="tt">f</span>  </td><td class="markdownTableBodyNone"><span class="tt">std::function&lt;void(const Inputs&amp;... , Outputs&amp;...)&gt;</span>  </td><td class="markdownTableBodyNone">Function matching the signature: <span class="tt">void(const Inputs&amp;... in, Outputs&amp;... out)</span>  </td></tr>
</table>
<p><a class="anchor" id="comppare_main_add_returnimpl"></a> </p><h5>Returns </h5>
<ul>
<li><p class="startli"><b><span class="tt">comppare::Impl&amp;</span></b></p>
<p class="startli">Reference to the internal <span class="tt">Impl</span> object representing the just-registered implementation. Used mainly for attaching to plugins like Google Benchmark.</p>
<p class="startli">Recommended to discard return value.</p>
</li>
</ul>
<h5>Example </h5>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> ref_impl(<span class="keyword">const</span> Inputs&amp;..., Outputs...){};</div>
<div class="line"><span class="keyword">auto</span> cmp = <a class="code hl_class" href="classcomppare_1_1_input_context.html">comppare::InputContext</a>&lt;Inputs...&gt;::OutputContext&lt;Outputs...&gt;();</div>
<div class="line"> </div>
<div class="line">cmp.set_reference(<span class="comment">/*display name*/</span><span class="stringliteral">&quot;reference implementation&quot;</span>, <span class="comment">/*function*/</span> ref_impl);</div>
<div class="line">cmp.add(<span class="comment">/*display name*/</span><span class="stringliteral">&quot;Optimized memcpy&quot;</span>, <span class="comment">/*function*/</span> fast_memcpy_impl);</div>
</div><!-- fragment --><h3>2.2.3. Running Framework </h3>
<h4><span class="tt">run</span> </h4>
<p>Runs all the added implementations into the comppare framework.</p>
<h5>Context </h5>
<p>Member of</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="classcomppare_1_1_input_context.html">comppare::InputContext</a>&lt;Inputs...&gt;::OutputContext&lt;Outputs...&gt;</div>
</div><!-- fragment --><h5>Signature </h5>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> run(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv);</div>
</div><!-- fragment --><h5>Parameters </h5>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Name  </th><th class="markdownTableHeadNone">Type  </th><th class="markdownTableHeadNone">Description  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><span class="tt">argc</span>  </td><td class="markdownTableBodyNone"><span class="tt">int</span>  </td><td class="markdownTableBodyNone">Number of Command Line Arguments  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><span class="tt">argv</span>  </td><td class="markdownTableBodyNone"><span class="tt">char**</span>  </td><td class="markdownTableBodyNone">Command Line Argument Vector  </td></tr>
</table>
<h5>Example </h5>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Create cmp object */</span></div>
<div class="line">    cmp.run(argc, argv);</div>
<div class="line">}</div>
</div><!-- fragment --><h3>2.2.4. Summary of <span class="tt">main()</span> </h3>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> reference_impl(<span class="keyword">const</span> Inputs&amp;... in,</div>
<div class="line">                    Outputs&amp;...      out);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> optimized_impl(<span class="keyword">const</span> Inputs&amp;... in,</div>
<div class="line">                    Outputs&amp;...      out);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv)</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_class" href="classcomppare_1_1_input_context.html">comppare::InputContext</a>&lt;Inputs...&gt;</div>
<div class="line">              ::OutputContext&lt;Outputs...&gt; </div>
<div class="line">                cmp(in...);</div>
<div class="line">    </div>
<div class="line">    cmp.set_reference(<span class="stringliteral">&quot;Reference&quot;</span>, reference_impl);</div>
<div class="line"> </div>
<div class="line">    cmp.add(<span class="stringliteral">&quot;Optimized&quot;</span>, optimized_impl);</div>
<div class="line"> </div>
<div class="line">    cmp.run(argc, argv);</div>
<div class="line">}</div>
</div><!-- fragment --><p> For more concrete example, please see examples.</p>
<h2>2.3. Google Benchmark Plugin</h2>
<h4><span class="tt">google_benchmark()</span> </h4>
<p>Attaches the Google Benchmark plugin when calling `set_reference` or `add`, enabling google benchmark to the current implementation.</p>
<hr  />
<h5>Context </h5>
<p>Member of an internal struct</p>
<div class="fragment"><div class="line">comppare::Impl</div>
</div><!-- fragment --><h5>Signature </h5>
<div class="fragment"><div class="line">benchmark::internal::Benchmark* google_benchmark();</div>
</div><!-- fragment --><h5>Returns </h5>
<ul>
<li><b><span class="tt">benchmark::internal::Benchmark*</span></b> Pointer to the underlying Google Benchmark <span class="tt">Benchmark</span> instance. Use this to chain additional benchmark configuration calls (e.g. <span class="tt">-&gt;Arg()</span>, <span class="tt">-&gt;Threads()</span>, <span class="tt">-&gt;Unit()</span>, etc.).</li>
</ul>
<h5>Detailed Description </h5>
<p>After registering an implementation via <span class="tt">set_reference</span> or <span class="tt">add</span>, both functions return a reference to an internal struct <span class="tt">comppare::Impl</span> <a class="el" href="#comppare_main_add_returnimpl">(see here)</a>. <span class="tt">google_benchmark()</span> attaches the plugin to the current implementation. The returned pointer allows you to further customize the benchmark before execution.</p>
<h5>Example </h5>
<div class="fragment"><div class="line">cmp.set_reference(<span class="stringliteral">&quot;Reference&quot;</span>, reference_impl)</div>
<div class="line">   .google_benchmark();</div>
<div class="line"> </div>
<div class="line">cmp.add(<span class="stringliteral">&quot;Optimized&quot;</span>, optimized_impl)</div>
<div class="line">   .google_benchmark();</div>
<div class="line"> </div>
<div class="line">cmp.run(argc, argv);</div>
</div><!-- fragment --><h3>Manual Timing with Google Benchmark </h3>
<p>Enable manual timing for any registered implementation by appending <span class="tt">-&gt;UseManualTime()</span> to the Benchmark* returned from google_benchmark(). This instructs Google Benchmark to measure only the intervals you explicitly mark inside your implementation, with Manual Timer Macros or SetIterationTime() macro.</p>
<p><span class="tt">UseManualTime()</span> is a Google Benchmark API call that switches the benchmark into Manual Timing mode. <a href="https://google.github.io/benchmark/user_guide.html#manual-timing">(See Google Benchmark's Documentation)</a></p>
<div class="fragment"><div class="line">impl_manualtimer_macro(...)</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a03adebee29527207e43a1b362d77fe65">HOTLOOPSTART</a>;</div>
<div class="line">    ...</div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a09770669e2181c6a712ea4512ded4e36">MANUAL_TIMER_START</a>;</div>
<div class="line">    ...</div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a6cde3e9e2e72f32aeb69aba4a09f353f">MANUAL_TIMER_END</a>;</div>
<div class="line">    ...</div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a3f983d0c821f40a98683debcc90a1e97">HOTLOOPEND</a>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">impl_setitertime_macro(...)</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a03adebee29527207e43a1b362d77fe65">HOTLOOPSTART</a>;</div>
<div class="line">    ...</div>
<div class="line">    <span class="keywordtype">double</span> elapsed_us;</div>
<div class="line">    SetIterationTime(elapsed_us)</div>
<div class="line">    ...</div>
<div class="line">    <a class="code hl_define" href="comppare_8hpp.html#a3f983d0c821f40a98683debcc90a1e97">HOTLOOPEND</a>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main()</div>
<div class="line">{</div>
<div class="line">    cmp.set_reference(<span class="stringliteral">&quot;Manual Timer Macro&quot;</span>, impl_manualtimer_macro)</div>
<div class="line">    .google_benchmark() </div>
<div class="line">        -&gt;UseManualTime();</div>
<div class="line"> </div>
<div class="line">    cmp.add(<span class="stringliteral">&quot;SetIterationTime Macro&quot;</span>, impl_setitertime_macro)</div>
<div class="line">    .google_benchmark() </div>
<div class="line">        -&gt;UseManualTime();</div>
<div class="line">}</div>
</div><!-- fragment --><h2>2.4. <span class="tt">DoNotOptimize()</span></h2>
<p>For a deep dive into the working principle of <span class="tt">DoNotOptimize()</span> please visit examples/advanced_demo/DoNotOptimize</p>
<h3>Disclaimer </h3>
<p>I, LF Fung, am not the author of <span class="tt">DoNotOptimize()</span>. The implementation of <span class="tt"><a class="el" href="namespacecomppare.html#a047cefc5aebc47d079d502c2d189fe12" title="Prevents the compiler from optimizing away the given value.">comppare::DoNotOptimize()</a></span> is a verbatim of Google Benchmark's <span class="tt">benchmark::DoNotOptimize()</span>.</p>
<h3>References: </h3>
<ol type="1">
<li><a href="https://www.youtube.com/watch?v=nXaxk27zwlk&amp;t=3319s">CppCon 2015: Chandler Carruth "Tuning C++: Benchmarks, and CPUs, and Compilers! Oh My!"</a> <br  />
</li>
<li><a href="https://github.com/google/benchmark">Google Benchmark Github Repository</a> <br  />
</li>
</ol>
<h3>2.4.1. Problem with Compiler Optimsation </h3>
<p>Compiler optimization can sometimes remove operations and variables completely.</p>
<p>For instance in the following function:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> SAXPY(<span class="keyword">const</span> <span class="keywordtype">float</span> a, <span class="keyword">const</span> <span class="keywordtype">float</span>* x, <span class="keyword">const</span> <span class="keywordtype">float</span>* y)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">float</span> yout;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; N; ++i)</div>
<div class="line">    {</div>
<div class="line">        yout = a * x[i] + y[i];</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>When compiling at high optimization, the compiler realizes <span class="tt">yout</span> is just a temporary that’s never used elsewhere. As a result, <span class="tt">yout</span> is optimized out, and thus the whole saxpy operation would be optimized out.</p>
<h4>SAXPY() in Assembly </h4>
<p>When SAXPY() is compiled in AArch64 with Optimisation <span class="tt">-O3</span> </p><div class="fragment"><div class="line">__Z5SAXPYfPKfS0_:                       ; @_Z5SAXPYfPKfS0_</div>
<div class="line">    .cfi_startproc</div>
<div class="line">; %bb.0:</div>
<div class="line">    ret</div>
<div class="line">    .cfi_endproc</div>
<div class="line">                                        ; -- End function</div>
</div><!-- fragment --><p> The function body is practically empty: a single <span class="tt">ret</span> which is “return from subroutine” <a href="https://developer.arm.com/documentation/dui0802/b/A64-General-Instructions/RET">Arm A64 Instruction Set: <b>RET</b></a>. In simple terms, it just returns — nothing happens.</p>
<h3>2.4.2. Solution &ndash; Google Benchmark's DoNotOptimize() </h3>
<p>Optimization is important to understand the performance of particular operations in production builds. This creates the conflicting ideas of <span class="tt">optimize</span> but <span class="tt">do not optimize away</span>. This was solved by Google in their <a href="https://github.com/google/benchmark">benchmark</a> &ndash; a microbenchmarking library. Google Benchmark provides <span class="tt">benchmark::DoNotOptimize()</span> to prevent variables from being optimized away.</p>
<p>With the same SAXPY function, we simply add DoNotOptimize() around the temporary variable <span class="tt">yout</span> </p><div class="fragment"><div class="line"><span class="keywordtype">void</span> SAXPY_DONOTOPTIMIZE(<span class="keyword">const</span> <span class="keywordtype">float</span> a, <span class="keyword">const</span> <span class="keywordtype">float</span>* x, <span class="keyword">const</span> <span class="keywordtype">float</span>* y)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">float</span> yout;</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; N; ++i)</div>
<div class="line">    {</div>
<div class="line">        yout = a * x[i] + y[i];</div>
<div class="line">        DoNotOptimize(yout);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p> This <span class="tt">DoNotOptimize</span> call tells the compiler not to eliminate the temporary variable, so the operation itself won’t be optimized away.</p>
<h4>SAXPY_DONOTOPTIMIZE() in Assembly </h4>
<p>When SAXPY_DONOTOPTIMIZE() is compiled in AArch64 with Optimisation <span class="tt">-O3</span>:</p>
<pre><code class="language-asm">
   <span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">5</span> __Z19SAXPY_DONOTOPTIMIZEfPKfS0_:        ; @_Z19SAXPY_DONOTOPTIMIZEfPKfS0_
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">6</span>       .cfi_startproc
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">7</span> ; bb.0:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">8</span>       sub     sp, sp, #16
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">9</span>       .cfi_def_cfa_offset 16
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">10</span>      mov     w8, #16960
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">11</span>      movk    w8, #15, lsl #16
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">12</span>      add     x9, sp, #4
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">13</span>      add     x10, sp, #8
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">14</span> LBB0_1:                                 ; =&gt;This Inner Loop Header: Depth=1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">15</span>      ldr     s1, [x0], #4
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">16</span>      ldr     s2, [x1], #4
<span style="display:inline-block;width:100%;white-space:pre;background-color:rgba(0, 255, 4, 0.49);border-radius:2px;"><span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">17</span>      fmadd   s1, s0, s1, s2</span>
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">18</span>      str     s1, [sp, #4]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">19</span>      str     x9, [sp, #8]
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">20</span>      ; InlineAsm Start
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">21</span>      ; InlineAsm End
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">22</span>      subs    x8, x8, #1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">23</span>      b.ne    LBB0_1
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">24</span> ; bb.2:
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">25</span>      add     sp, sp, #16
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">26</span>      ret
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">27</span>      .cfi_endproc
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">28</span>                                         ; -- End function
</code></pre><p><br  />
</p>
<p>Further inspection reveals the Fused-Multiply-Add instruction &ndash; indicating that SAXPY operation was not optimized away. </p><pre><code class="language-asm">
<span style="opacity:0.5; font-size:smaller; display:inline-block; width:3em; text-align:right;">17</span>      fmadd   s0, s0, s1, s2
</code></pre><p><a href="https://developer.arm.com/documentation/ddi0602/2025-06/SIMD-FP-Instructions/FMADD--Floating-point-fused-multiply-add--scalar--">Reference to Arm A64 Instruction Set: <b>FMADD</b></a></p>
<h3>2.4.3. <span class="tt"><a class="el" href="namespacecomppare.html#a047cefc5aebc47d079d502c2d189fe12" title="Prevents the compiler from optimizing away the given value.">comppare::DoNotOptimize()</a></span> </h3>
<p>Provided the usefulness of Google Benchmark's <span class="tt">benchmark::DoNotOptimize()</span>, comppare includes a verbatim of <span class="tt">benchmark::DoNotOptimize()</span>.</p>
<p>Example: </p><div class="fragment"><div class="line">impl(...)</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">    <a class="code hl_function" href="namespacecomppare.html#a047cefc5aebc47d079d502c2d189fe12">comppare::DoNotOptimize</a>(temporary_variable);</div>
<div class="line">    ...</div>
<div class="line">}</div>
<div class="ttc" id="anamespacecomppare_html_a047cefc5aebc47d079d502c2d189fe12"><div class="ttname"><a href="namespacecomppare.html#a047cefc5aebc47d079d502c2d189fe12">comppare::DoNotOptimize</a></div><div class="ttdeci">void DoNotOptimize(T const &amp;value)</div><div class="ttdoc">Prevents the compiler from optimizing away the given value.</div><div class="ttdef"><b>Definition</b> comppare.hpp:103</div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
