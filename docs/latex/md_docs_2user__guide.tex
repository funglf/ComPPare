\chapter{User Guide Com\+PPare -- Validation \& Benchmarking Framework  }
\hypertarget{md_docs_2user__guide}{}\label{md_docs_2user__guide}\index{User Guide ComPPare -- Validation \& Benchmarking Framework $<$"!-\/-\/ omit from toc -\/-\/$>$@{User Guide ComPPare -- Validation \& Benchmarking Framework $<$"!-\/-\/ omit from toc -\/-\/$>$}}

\begin{DoxyItemize}
\item 1. Getting Started
\begin{DoxyItemize}
\item 1.1. Install
\item 1.2. Basic Usage
\item 1.3. Basic Working Principle
\end{DoxyItemize}
\item 2. User API Documentation
\begin{DoxyItemize}
\item 2.1. Macros
\item 2.2. Com\+PPare \`{}main()\`{}
\item 2.3. Google Benchmark Plugin
\item 2.4. \`{}\+Do\+Not\+Optimize()\`{}
\end{DoxyItemize}
\end{DoxyItemize}

\doxysection*{1. Getting Started}

\doxysubsection*{1.\+1. Install}

\doxysubsubsection*{1.\+1.\+1. Clone repository }


\begin{DoxyCode}{0}
\DoxyCodeLine{git\ clone\ git@github.com:funglf/ComPPare.git\ -\/-\/recursive}

\end{DoxyCode}
 \doxysubsubsubsection*{If submodules like google benchmark/ nvbench is not needed\+: }


\begin{DoxyCode}{0}
\DoxyCodeLine{git\ clone\ git@github.com:funglf/ComPPare.git}

\end{DoxyCode}


\doxysubsubsection*{1.\+1.\+2. (Optional) Build Google Benchmark }

See \href{https://github.com/google/benchmark/blob/b20cea674170b2ba45da0dfaf03953cdea473d0d/README.md}{\texttt{Google Benchmark Instructions}}

\doxysubsubsection*{1.\+1.\+3. Include Com\+PPare }

In your C++ code, simply include the comppare header file by\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{comppare_8hpp}{comppare/comppare.hpp}}>}}

\end{DoxyCode}


\doxysubsection*{1.\+2. Basic Usage}

There are a few rules in order to use comppare.

\doxysubsubsection*{1.\+2.\+1. Adopt the required function signature }

{\itshape Function output must be {\ttfamily void}} and consists of the input, then output types 
\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ impl(\textcolor{keyword}{const}\ Inputs\&...\ in,\ \ \ \ \ \textcolor{comment}{//\ read‑only\ inputs}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ Outputs\&...\ \ \ \ \ \ out);\ \ \ \ \ \textcolor{comment}{//\ outputs\ compared\ to\ reference}}

\end{DoxyCode}


\doxysubsubsection*{1.\+2.\+2. Add {\ttfamily HOTLOOP} Macros }

In order to benchmark specific regions of code, following Macros {\ttfamily HOTLOOPSTART}, {\ttfamily HOTLOOPEND} are needed. The region in between will be ran multiple times in order to get an accurate timing. The region first runs certain iterations of warmup before actually running the benchmark iterations.

\doxysubsubsubsection*{How to use {\ttfamily HOTLOOPSTART}/{\ttfamily HOTLOOPEND} Macros }


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ impl(\textcolor{keyword}{const}\ Inputs\&...\ in,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ Outputs\&...\ \ \ \ \ \ out);}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{/*\ }}
\DoxyCodeLine{\textcolor{comment}{\ \ \ \ setup\ or\ overhead\ you\ DO\ NOT\ want\ to\ benchmark\ }}
\DoxyCodeLine{\textcolor{comment}{\ \ \ \ -\/-\/\ memory\ allocation,\ data\ transfer,\ etc.}}
\DoxyCodeLine{\textcolor{comment}{\ \ \ \ */}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{comppare_8hpp_a03adebee29527207e43a1b362d77fe65}{HOTLOOPSTART}};\ \textcolor{comment}{//\ Macro\ of\ start\ of\ Benchmarking\ Region\ of\ Interest}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{//\ ...\ perform\ core\ computation\ here\ ...}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{comppare_8hpp_a3f983d0c821f40a98683debcc90a1e97}{HOTLOOPEND}};\ \ \ \textcolor{comment}{//\ Macro\ of\ end\ of\ Benchmarking\ Region\ of\ Interest}}
\DoxyCodeLine{\}}

\end{DoxyCode}


\doxysubsubsubsection*{Alternate Macro }

Alternatively, the macro {\ttfamily \doxylink{comppare_8hpp_a171973717bfe2c264acae42f9e1ad486}{HOTLOOP()}} can be used to wrap the whole region. 
\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ impl(\textcolor{keyword}{const}\ Inputs\&...\ in,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ Outputs\&...\ \ \ \ \ \ out);}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{comppare_8hpp_a171973717bfe2c264acae42f9e1ad486}{HOTLOOP}}(}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{//\ ...\ perform\ core\ computation\ here\ ...}}
\DoxyCodeLine{\ \ \ \ );}
\DoxyCodeLine{\}}

\end{DoxyCode}


\doxysubsubsection*{1.\+2.\+3. Setting up Comparison in {\ttfamily main()} }

In {\ttfamily main()}, you can setup the comparison, such as defining the reference function, initializing input data, naming of benchmark etc.

\begin{quote}
\#\#\# The SAXPY example will be used throughout this section to demonstrate on usage \texorpdfstring{$>$}{>}{\bfseries{SAXPY}} stands for {\bfseries{Single-\/\+Precision A·X Plus Y}}. (Also see examples/saxpy)

It stands for the following operation\+:

\texorpdfstring{$>$}{>}\$\$ \texorpdfstring{$>$}{>}y\+\_\+\{\textbackslash{}text\{out\}\}\mbox{[}i\mbox{]} = a \textbackslash{}cdot x\mbox{[}i\mbox{]} + y\mbox{[}i\mbox{]} \texorpdfstring{$>$}{>}\$\$ \end{quote}


Based on Section \mbox{[}Basic Usage\mbox{]}, we can define a {\ttfamily saxpy} function as\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ saxpy\_cpu(\textcolor{comment}{/*Input\ types*/}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{float}\ a,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ std::vector<float>\ \&x,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ std::vector<float>\ \&y\_in,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*Output\ types*/}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::vector<float>\ \&y\_out)}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{comppare_8hpp_a03adebee29527207e43a1b362d77fe65}{HOTLOOPSTART}};}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ x.size();\ ++i)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ y\_out[i]\ =\ a\ *\ x[i]\ +\ y\_in[i];}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{comppare_8hpp_a3f983d0c821f40a98683debcc90a1e97}{HOTLOOPEND}};}
\DoxyCodeLine{\}}

\end{DoxyCode}
 \DoxyHorRuler{0}
 \doxysubsubsubsection*{Step 1\+: Initialize Input data }


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{comment}{/*\ Intialize\ Input\ data\ */}}
\DoxyCodeLine{\textcolor{keywordtype}{float}\ a\ =\ 1.1f}
\DoxyCodeLine{std::vector\ x(1000,\ 1.0);\ }
\DoxyCodeLine{std::vector\ y\_in(1000,\ 2.0);}

\end{DoxyCode}
 \DoxyHorRuler{0}
 \doxysubsubsubsection*{Step 2\+: Create a Comparison Object }

This step defines the input and output types of the functions you are about to test.

For {\ttfamily saxpy\+\_\+cpu}, the {\bfseries{input types}} are\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{comment}{/*\ INPUTS:\ */}}
\DoxyCodeLine{float,}
\DoxyCodeLine{std::vector<float>,}
\DoxyCodeLine{std::vector<float>}

\end{DoxyCode}


Let\textquotesingle{}s define an alias here based on the Input Types\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keyword}{using\ }CMP\_INPUT\ =\ \mbox{\hyperlink{namespacecomppare}{comppare}}::}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{/*Define\ Input\ Pack\ Types\ same\ as\ the\ function*/}}
\DoxyCodeLine{\ \ \ \ InputContext<}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ float,\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*float\ a*/}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::vector<float>,\ \textcolor{comment}{/*std::vector<float>\ x*/}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::vector<float>\ \ \textcolor{comment}{/*std::vector<float>\ y*/}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ >::}

\end{DoxyCode}


\DoxyHorRuler{0}


As for the {\bfseries{output types}}\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{comment}{/*\ OUTPUTS:\ */}}
\DoxyCodeLine{std::vector<float>}

\end{DoxyCode}
 Let\textquotesingle{}s define another alias based on the Output Types\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keyword}{using\ }CMP\ =\ CMP\_INPUT::}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{/*Define\ Output\ Pack\ types\ same\ as\ the\ function*/}}
\DoxyCodeLine{\ \ \ \ OutputContext<}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::vector<float>\ \ \textcolor{comment}{/*std::vector<float>\ y\_out*/}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ >;}

\end{DoxyCode}


\DoxyHorRuler{0}


Finally, we can create our comparison object with the alias {\ttfamily CMP} and initialize with the input data\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{CMP\ cmp(a,x,y\_in);\ \textcolor{comment}{//\ Input\ data\ initialized\ above}}

\end{DoxyCode}


\DoxyHorRuler{0}
 {\bfseries{Or, define all at once without alias\+:}}

Therefore, we can define the comparison object as\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{\mbox{\hyperlink{namespacecomppare}{comppare}}::\ \textcolor{comment}{/*namespace\ comppare*/}}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{/*Define\ Input\ Pack\ Types\ same\ as\ the\ function*/}}
\DoxyCodeLine{\ \ \ \ InputContext<}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ float,\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*float\ a*/}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::vector<float>,\ \textcolor{comment}{/*std::vector<float>\ x*/}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::vector<float>\ \ \textcolor{comment}{/*std::vector<float>\ y*/}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ >::}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{/*Define\ Output\ Pack\ types\ same\ as\ the\ function*/}}
\DoxyCodeLine{\ \ \ \ OutputContext<}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::vector<float>\ \ \textcolor{comment}{/*std::vector<float>\ y\_out*/}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ >;}
\DoxyCodeLine{\ \ \ \ }
\DoxyCodeLine{\ \ \ \ cmp(a,x,y\_in);\ \ \ \textcolor{comment}{//cmp\ object\ -\/-\/\ a,x,y\ data}}

\end{DoxyCode}


\doxysubsubsubsection*{Step 3\+: Register/\+Add Functions into framework }

After creating the {\ttfamily cmp} object, we can add functions into it.

To Define the reference function\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{cmp.set\_reference(\textcolor{comment}{/*Displayed\ Name\ After\ Benchmark*/}\textcolor{stringliteral}{"{}saxpy\ reference"{}},\ \textcolor{comment}{/*Function*/}saxpy\_cpu);}

\end{DoxyCode}


To Add more fucntions\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{cmp.add(\textcolor{stringliteral}{"{}saxpy\ gpu"{}},\ saxpy\_gpu);}

\end{DoxyCode}


\doxysubsubsubsection*{Step 4\+: Run the Benchmarks }

Command line arguments are the parameters for run()\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{cmp.run(argc,\ argv);}

\end{DoxyCode}


\doxysubsubsubsection*{Step 5\+: Results }

Example Output\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=}
\DoxyCodeLine{============\ ComPPare\ Framework\ ============}
\DoxyCodeLine{=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*}
\DoxyCodeLine{}
\DoxyCodeLine{Number\ of\ implementations:\ \ \ \ \ \ \ \ \ \ \ \ \ 3}
\DoxyCodeLine{Warmup\ iterations:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 100}
\DoxyCodeLine{Benchmark\ iterations:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 100}
\DoxyCodeLine{=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*=*}
\DoxyCodeLine{}
\DoxyCodeLine{Implementation\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Func\ µs\ \ \ \ \ \ \ \ \ \ \ \ \ ROI\ µs\ \ \ \ \ \ \ \ \ \ \ \ Ovhd\ µs\ \ \ \ \ \ \ \ \ Max|err|[0]\ \ \ \ \ \ \ \ Mean|err|[0]\ \ \ \ \ \ \ Total|err|[0]}
\DoxyCodeLine{saxpy\ reference\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 38.01\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 15.97\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 22.05\ \ \ \ \ \ \ \ \ \ \ \ 0.00e+00\ \ \ \ \ \ \ \ \ \ \ \ 0.00e+00\ \ \ \ \ \ \ \ \ \ \ \ 0.00e+00}
\DoxyCodeLine{saxpy\ gpu\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 73151.41\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ 1.07\ \ \ \ \ \ \ \ \ \ \ \ 73150.34\ \ \ \ \ \ \ \ \ \ \ \ 3.30e+06\ \ \ \ \ \ \ \ \ \ \ \ 1.66e+06\ \ \ \ \ \ \ \ \ \ \ \ 1.70e+09\ \ <-\/-\/\ FAIL}

\end{DoxyCode}
 In this case, {\ttfamily saxpy\+\_\+gpu} failed.

\doxysubsubsection*{1.\+2.\+4. Command Line Options -- Iterations }

There are 2 commmand line options to control the number of warmup and benchmark iterations\+:

\doxysubsubsubsection*{{\ttfamily -\/-\/warmups} Warmup Iterations }

When used with a unsigned 64 bit integer, this sets the number of warmup iterations before running benchmark runs.

Example\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{./saxpy\ -\/-\/warmups\ 1000}

\end{DoxyCode}


\doxysubsubsubsection*{{\ttfamily -\/-\/iters} Benchmark Iterations }

When used with a unsigned 64 bit integer, this sets the number of benchmark iterations

Example\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{./saxpy\ -\/-\/iters\ 1000}

\end{DoxyCode}


\doxysubsection*{1.\+3. Basic Working Principle}

\doxysubsubsection*{1.\+3.\+1. {\ttfamily HOTLOOP} Macros }

HOTLOOP Macros essentially wrap your region of interest in a lambda before running the lambda across the warmup and benchmark iterations. The region of iterest is being timed across all the benchmark iterations to obtain an average runtime.

In {\ttfamily \doxylink{comppare_8hpp}{comppare/comppare.\+hpp}}, {\ttfamily HOTLOOPSTART} and {\ttfamily HOTLOOPEND} are defined as\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#define\ HOTLOOPSTART\ \(\backslash\)}}
\DoxyCodeLine{\textcolor{preprocessor}{\ \ \ \ auto\ \&\&hotloop\_body\ =\ [\&]()\ \{\ }\textcolor{comment}{/*\ start\ of\ lambda\ */}\textcolor{preprocessor}{}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{preprocessor}{\#define\ HOTLOOPEND\ \ \ \ \ \(\backslash\)}}
\DoxyCodeLine{\textcolor{preprocessor}{\ \ \ \ \};\ }\textcolor{comment}{/*\ end\ lambda\ */}\textcolor{preprocessor}{\ \(\backslash\)}}

\end{DoxyCode}


Therefore, any code in between the 2 macros are simply wrapped into the lambda {\ttfamily hotloop\+\_\+body}\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{\mbox{\hyperlink{comppare_8hpp_a03adebee29527207e43a1b362d77fe65}{HOTLOOPSTART}};}
\DoxyCodeLine{foo();}
\DoxyCodeLine{\mbox{\hyperlink{comppare_8hpp_a3f983d0c821f40a98683debcc90a1e97}{HOTLOOPEND}};}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{/*\ is\ equivalent\ to\ */}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{auto}\ \&\&hotloop\_body\ =\ [\&]()\ \{}
\DoxyCodeLine{\ \ \ \ foo();}
\DoxyCodeLine{\};}

\end{DoxyCode}


After that, the lambda is being ran\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{comment}{/*\ Warm-\/up\ */}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ warmup\_iterations;\ ++i)\ }
\DoxyCodeLine{\ \ \ \ hotloop\_body();\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\textcolor{comment}{/*\ Benchmark\ */}}
\DoxyCodeLine{\textcolor{keyword}{auto}\ start\ =\ now();\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\textcolor{keywordflow}{for}\ (i\ =\ 0;\ i\ <\ benchmark\_iterations;\ ++i)\ \ }
\DoxyCodeLine{\ \ \ \ hotloop\_body();\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }
\DoxyCodeLine{\textcolor{keyword}{auto}\ end\ =\ now();\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }

\end{DoxyCode}


\doxysubsubsection*{1.\+3.\+2. Output Comparison }

Each implementation follows the same signature\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ impl(\textcolor{keyword}{const}\ Inputs\&...\ in,\ \ \ \ \ \textcolor{comment}{//\ read‑only\ inputs}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ Outputs\&...\ \ \ \ \ \ out);\ \ \ \ \ \textcolor{comment}{//\ outputs\ compared\ to\ reference}}

\end{DoxyCode}
 {\bfseries{Input}} – Passed in by the framework. All candidates get exactly the same data.

{\bfseries{Output}} – The framework creates private output objects and passes into the implementation by reference. Therefore any change in the object will be stored in the framework.

After each implementation has finished running, the framework compares each output against the reference implementation, and prints out the results in terms of difference/error and whether it has failed.

\doxysection*{2. User API Documentation}

\doxysubsection*{2.\+1. Macros}

\doxysubsubsection*{2.\+1.\+1 hotloop Macros }

\doxysubsubsubsection*{{\ttfamily HOTLOOPSTART} \& {\ttfamily HOTLOOPEND} }

Used to wrap around region of {\bfseries{CPU functions/operations}} for framework to benchmark

example\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{impl(...)}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{comppare_8hpp_a03adebee29527207e43a1b362d77fe65}{HOTLOOPSTART}};}
\DoxyCodeLine{\ \ \ \ cpu\_func();}
\DoxyCodeLine{\ \ \ \ a+b;}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{comppare_8hpp_a3f983d0c821f40a98683debcc90a1e97}{HOTLOOPEND}};}
\DoxyCodeLine{\}}

\end{DoxyCode}
 \doxysubsubsubsection*{{\ttfamily \doxylink{comppare_8hpp_a171973717bfe2c264acae42f9e1ad486}{HOTLOOP()}} }

Alternative of HOTLOOPSTART/\+END

example\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{impl(...)}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{comppare_8hpp_a171973717bfe2c264acae42f9e1ad486}{HOTLOOP}}(}
\DoxyCodeLine{\ \ \ \ cpu\_func();}
\DoxyCodeLine{\ \ \ \ a+b;}
\DoxyCodeLine{\ \ \ \ );}
\DoxyCodeLine{\}}

\end{DoxyCode}
 \doxysubsubsubsection*{{\ttfamily GPU\+\_\+\+HOTLOOPSTART} \& {\ttfamily GPU\+\_\+\+HOTLOOPEND} }

Host Macro to wrap around region of {\bfseries{GPU host functions/operations}} for framework to benchmark. Supports both CUDA and HIP, provided that the host function is compiled with the respected CUDA-\/compiler-\/wrapper {\ttfamily nvcc} and HIP-\/compiler-\/wrapper {\ttfamily hipcc}

\begin{quote}
{\bfseries{Warning}} Do Not use this within GPU kernels. \end{quote}


example\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{gpu\_impl(...)}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ GPU\_HOTLOOPSTART;}
\DoxyCodeLine{\ \ \ \ kernel<<<...>>>(...)}
\DoxyCodeLine{\ \ \ \ cudaMemcpy(...);}
\DoxyCodeLine{\ \ \ \ GPU\_HOTLOOPEND;}
\DoxyCodeLine{\}}

\end{DoxyCode}
 \doxysubsubsubsection*{{\ttfamily GPU\+\_\+\+HOTLOOP()} }

Alternative of GPU\+\_\+\+HOTLOOPSTART/\+END

example\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{gpu\_impl(...)}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ GPU\_HOTLOOP(}
\DoxyCodeLine{\ \ \ \ kernel<<<...>>>(...)}
\DoxyCodeLine{\ \ \ \ cudaMemcpy(...);}
\DoxyCodeLine{\ \ \ \ );}
\DoxyCodeLine{\}}

\end{DoxyCode}


\doxysubsubsection*{2.\+1.\+2 Manual timer Macros }

\doxysubsubsubsection*{{\ttfamily MANUAL\+\_\+\+TIMER\+\_\+\+START} \& {\ttfamily MANUAL\+\_\+\+TIMER\+\_\+\+END} }

Used to wrap around region of CPU functions/operations {\bfseries{within HOTLOOP}}

\begin{quote}
These set of macros can {\bfseries{ONLY be used once}} within the Hotloop \end{quote}


Example -- Only times {\ttfamily a+b}\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{impl(...)}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{comppare_8hpp_a03adebee29527207e43a1b362d77fe65}{HOTLOOPSTART}};}
\DoxyCodeLine{\ \ \ \ cpu\_func();}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{comppare_8hpp_a09770669e2181c6a712ea4512ded4e36}{MANUAL\_TIMER\_START}}}
\DoxyCodeLine{\ \ \ \ a+b;}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{comppare_8hpp_a6cde3e9e2e72f32aeb69aba4a09f353f}{MANUAL\_TIMER\_END}}}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{comppare_8hpp_a3f983d0c821f40a98683debcc90a1e97}{HOTLOOPEND}};}
\DoxyCodeLine{\}}

\end{DoxyCode}


\doxysubsubsubsection*{{\ttfamily GPU\+\_\+\+MANUAL\+\_\+\+TIMER\+\_\+\+START} \& {\ttfamily GPU\+\_\+\+MANUAL\+\_\+\+TIMER\+\_\+\+END} }

Used to wrap around region of GPU host functions/operations {\bfseries{within HOTLOOP}}. Supports both CUDA and HIP, provided that the host function is compiled with the respected CUDA-\/compiler-\/wrapper {\ttfamily nvcc} and HIP-\/compiler-\/wrapper {\ttfamily hipcc}

\begin{quote}
These set of macros can {\bfseries{ONLY be used once}} within the Hotloop \end{quote}


Example -- Only times kernel\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{gpu\_impl(...)}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ GPU\_HOTLOOPSTART;}
\DoxyCodeLine{\ \ \ \ GPU\_MANUAL\_TIMER\_START;}
\DoxyCodeLine{\ \ \ \ kernel<<<...>>>(...)}
\DoxyCodeLine{\ \ \ \ GPU\_MANUAL\_TIMER\_END;}
\DoxyCodeLine{\ \ \ \ cudaMemcpy(...);}
\DoxyCodeLine{\ \ \ \ GPU\_HOTLOOPEND;}
\DoxyCodeLine{\}}

\end{DoxyCode}


\doxysubsubsection*{2.\+1.\+3 Custom iteration timer Macro }

\doxysubsubsubsection*{{\ttfamily \doxylink{comppare_8hpp_a8293881eb66cf6e561c6533b3af71ea1}{SET\+\_\+\+ITERATION\+\_\+\+TIME(us)}} }

This Macro takes in a \texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}floating point number representing time of current iteration in \$\textbackslash{}mu s\$\texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}

Example on mixed timers\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{mixed\_impl(...)}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ cudaEvent\_t\ gpu\_start,\ gpu\_end;}
\DoxyCodeLine{\ \ \ \ cudaEventCreate(\&gpu\_start);\ \ \ \ \ \ \ \ \ \ \ \ \ \ \(\backslash\)}
\DoxyCodeLine{\ \ \ \ cudaEventCreate(\&gpu\_end);}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{comppare_8hpp_a03adebee29527207e43a1b362d77fe65}{HOTLOOPSTART}};}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{/*\ Timing\ CPU\ region\ of\ cpu\_func()\ only*/}}
\DoxyCodeLine{\ \ \ \ \textcolor{keyword}{auto}\ cpu\_start\ =\ chrono::steady\_clock::now();}
\DoxyCodeLine{\ \ \ \ cpu\_func();}
\DoxyCodeLine{\ \ \ \ \textcolor{keyword}{auto}\ cpu\_end\ =\ chrono::steady\_clock::now();}
\DoxyCodeLine{\ \ \ \ a+b}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{/*\ Microseconds\ taken\ by\ cpu\_func()\ */}}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordtype}{float}\ cpu\_us\ =\ std::chrono::duration<float,\ std::micro>(end\ -\/\ start).count();}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{/*\ Timing\ GPU\ region\ of\ kernel\ only\ */}}
\DoxyCodeLine{\ \ \ \ cudaEventRecord(gpu\_start);}
\DoxyCodeLine{\ \ \ \ kernel<<<...>>>(...)}
\DoxyCodeLine{\ \ \ \ cudaEventRecord(gpu\_end);}
\DoxyCodeLine{\ \ \ \ cudaMemcpy(...);}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{/*\ Microseconds\ taken\ by\ gpu\ kernel\ */}}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordtype}{float}\ gpu\_ms;}
\DoxyCodeLine{\ \ \ \ cudaEventElapsedTime(\&ms\_manual,\ gpu\_start,\ gpu\_end);}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordtype}{float}\ gpu\_us\ =\ gpu\_ms\ *\ 1e3;}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{/*\ set\ the\ total\ iteration\ time\ in\ us\ */}}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordtype}{float}\ total\_iteration\_us\ =\ cpu\_us\ +\ gpu\_us;}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{comppare_8hpp_a8293881eb66cf6e561c6533b3af71ea1}{SET\_ITERATION\_TIME}}(total\_iteration\_us);}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{comppare_8hpp_a3f983d0c821f40a98683debcc90a1e97}{HOTLOOPEND}};}
\DoxyCodeLine{\}}

\end{DoxyCode}


\doxysubsection*{2.\+2. Com\+PPare {\ttfamily main()}}

\doxysubsubsection*{2.\+2.\+1. Creating the Com\+PPare object }

Given your implementation signature\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ impl(\textcolor{keyword}{const}\ Inputs\&...\ in,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ Outputs\&...\ \ \ \ \ \ out);}

\end{DoxyCode}


Instantiate the comparison context by forwarding the input arguments into the nested {\ttfamily Output\+Context} constructor\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\mbox{\hyperlink{classcomppare_1_1_input_context}{comppare::InputContext}}<Inputs...>}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ ::OutputContext<Outputs...>\ }
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ cmp(in...);}

\end{DoxyCode}



\begin{DoxyItemize}
\item {\bfseries{{\ttfamily Inputs...}}} Variadic template parameters corresponding to the {\bfseries{types}} of the input arguments of {\ttfamily impl} (e.\+g. {\ttfamily float}, {\ttfamily std\+::vector\texorpdfstring{$<$}{<}int\texorpdfstring{$>$}{>}}, etc.).
\item {\bfseries{{\ttfamily Outputs...}}} Variadic template parameters corresponding to the {\bfseries{types}} of the output arguments of {\ttfamily impl}.
\end{DoxyItemize}

The order of {\ttfamily Inputs...} and {\ttfamily Outputs...} must match the order in the {\ttfamily impl} signature. After construction, {\ttfamily cmp} is ready to have implementations registered (via {\ttfamily set\+\_\+reference} / {\ttfamily add}) and executed (via {\ttfamily run}).

\doxysubsubsection*{2.\+2.\+2. Setting Implementations for Framework }

\doxysubsubsubsection*{{\ttfamily set\+\_\+reference} }

Registers the “reference” implementation and returns its corresponding {\ttfamily Impl} descriptor for further configuration -- eg attaching to Plugins like Google Benchmark.

\doxysubsubsubsubsection*{Context }

Member of


\begin{DoxyCode}{0}
\DoxyCodeLine{\mbox{\hyperlink{classcomppare_1_1_input_context}{comppare::InputContext}}<Inputs...>::OutputContext<Outputs...>}

\end{DoxyCode}


\doxysubsubsubsubsection*{Signature }


\begin{DoxyCode}{0}
\DoxyCodeLine{comppare::Impl\&\ set\_reference(}
\DoxyCodeLine{\ \ \ \ std::string\ display\_name,}
\DoxyCodeLine{\ \ \ \ std::function<\textcolor{keywordtype}{void}(\textcolor{keyword}{const}\ Inputs\&...\ ,\ Outputs\&...)>\ f}
\DoxyCodeLine{);}

\end{DoxyCode}


\doxysubsubsubsubsection*{Parameters }

\tabulinesep=1mm
\begin{longtabu}spread 0pt [c]{*{3}{|X[-1]}|}
\hline
\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Name  }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Type  }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Description  }\\\cline{1-3}
\endfirsthead
\hline
\endfoot
\hline
\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Name  }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Type  }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Description  }\\\cline{1-3}
\endhead
{\ttfamily display\+\_\+name}  &{\ttfamily std\+::string}  &Human-\/readable label for this reference implementation. Used in output report.  \\\cline{1-3}
{\ttfamily f}  &{\ttfamily std\+::function\texorpdfstring{$<$}{<}void(const Inputs\&... , Outputs\&...)\texorpdfstring{$>$}{>}}  &Function matching the signature\+: {\ttfamily void(const Inputs\&... in, Outputs\&... out)}  \\\cline{1-3}
\end{longtabu}


\doxysubsubsubsubsection*{Returns }


\begin{DoxyItemize}
\item {\bfseries{{\ttfamily comppare\+::\+Impl\&}}}

Reference to the internal {\ttfamily Impl} object representing the just-\/registered implementation. Used mainly for attaching to plugins like Google Benchmark.

Recommended to discard return value.
\end{DoxyItemize}

\doxysubsubsubsubsection*{Example }


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ ref\_impl(\textcolor{keyword}{const}\ Inputs\&...,\ Outputs...)\{\};}
\DoxyCodeLine{\textcolor{keyword}{auto}\ cmp\ =\ \mbox{\hyperlink{classcomppare_1_1_input_context}{comppare::InputContext}}<Inputs...>::OutputContext<Outputs...>();}
\DoxyCodeLine{}
\DoxyCodeLine{cmp.set\_reference(\textcolor{comment}{/*display\ name*/}\textcolor{stringliteral}{"{}reference\ implementation"{}},\ \textcolor{comment}{/*function*/}\ ref\_impl);}

\end{DoxyCode}


\DoxyHorRuler{0}
 \doxysubsubsubsection*{{\ttfamily add} }

Registers additional implementation which will be compared against reference and returns its corresponding {\ttfamily Impl} descriptor for further configuration -- eg attaching to Plugins like Google Benchmark.

\doxysubsubsubsubsection*{Context }

Member of


\begin{DoxyCode}{0}
\DoxyCodeLine{\mbox{\hyperlink{classcomppare_1_1_input_context}{comppare::InputContext}}<Inputs...>::OutputContext<Outputs...>}

\end{DoxyCode}


\doxysubsubsubsubsection*{Signature }


\begin{DoxyCode}{0}
\DoxyCodeLine{comppare::Impl\&\ add(}
\DoxyCodeLine{\ \ \ \ std::string\ display\_name,}
\DoxyCodeLine{\ \ \ \ std::function<\textcolor{keywordtype}{void}(\textcolor{keyword}{const}\ Inputs\&...\ ,\ Outputs\&...)>\ f}
\DoxyCodeLine{);}

\end{DoxyCode}


\doxysubsubsubsubsection*{Parameters }

\tabulinesep=1mm
\begin{longtabu}spread 0pt [c]{*{3}{|X[-1]}|}
\hline
\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Name  }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Type  }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Description  }\\\cline{1-3}
\endfirsthead
\hline
\endfoot
\hline
\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Name  }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Type  }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Description  }\\\cline{1-3}
\endhead
{\ttfamily display\+\_\+name}  &{\ttfamily std\+::string}  &Human-\/readable label for this reference implementation. Used in output report.  \\\cline{1-3}
{\ttfamily f}  &{\ttfamily std\+::function\texorpdfstring{$<$}{<}void(const Inputs\&... , Outputs\&...)\texorpdfstring{$>$}{>}}  &Function matching the signature\+: {\ttfamily void(const Inputs\&... in, Outputs\&... out)}  \\\cline{1-3}
\end{longtabu}


\label{md_docs_2user__guide_comppare_main_add_returnimpl}%
\Hypertarget{md_docs_2user__guide_comppare_main_add_returnimpl}%
 \doxysubsubsubsubsection*{Returns }


\begin{DoxyItemize}
\item {\bfseries{{\ttfamily comppare\+::\+Impl\&}}}

Reference to the internal {\ttfamily Impl} object representing the just-\/registered implementation. Used mainly for attaching to plugins like Google Benchmark.

Recommended to discard return value.
\end{DoxyItemize}

\doxysubsubsubsubsection*{Example }


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ ref\_impl(\textcolor{keyword}{const}\ Inputs\&...,\ Outputs...)\{\};}
\DoxyCodeLine{\textcolor{keyword}{auto}\ cmp\ =\ \mbox{\hyperlink{classcomppare_1_1_input_context}{comppare::InputContext}}<Inputs...>::OutputContext<Outputs...>();}
\DoxyCodeLine{}
\DoxyCodeLine{cmp.set\_reference(\textcolor{comment}{/*display\ name*/}\textcolor{stringliteral}{"{}reference\ implementation"{}},\ \textcolor{comment}{/*function*/}\ ref\_impl);}
\DoxyCodeLine{cmp.add(\textcolor{comment}{/*display\ name*/}\textcolor{stringliteral}{"{}Optimized\ memcpy"{}},\ \textcolor{comment}{/*function*/}\ fast\_memcpy\_impl);}

\end{DoxyCode}


\doxysubsubsection*{2.\+2.\+3. Running Framework }

\doxysubsubsubsection*{{\ttfamily run} }

Runs all the added implementations into the comppare framework.

\doxysubsubsubsubsection*{Context }

Member of


\begin{DoxyCode}{0}
\DoxyCodeLine{\mbox{\hyperlink{classcomppare_1_1_input_context}{comppare::InputContext}}<Inputs...>::OutputContext<Outputs...>}

\end{DoxyCode}


\doxysubsubsubsubsection*{Signature }


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ run(\textcolor{keywordtype}{int}\ argc,\ \textcolor{keywordtype}{char}**\ argv);}

\end{DoxyCode}


\doxysubsubsubsubsection*{Parameters }

\tabulinesep=1mm
\begin{longtabu}spread 0pt [c]{*{3}{|X[-1]}|}
\hline
\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Name  }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Type  }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Description  }\\\cline{1-3}
\endfirsthead
\hline
\endfoot
\hline
\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Name  }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Type  }&\PBS\centering \cellcolor{\tableheadbgcolor}\textbf{ Description  }\\\cline{1-3}
\endhead
{\ttfamily argc}  &{\ttfamily int}  &Number of Command Line Arguments  \\\cline{1-3}
{\ttfamily argv}  &{\ttfamily char\texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}}  &Command Line Argument Vector  \\\cline{1-3}
\end{longtabu}


\doxysubsubsubsubsection*{Example }


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keywordtype}{int}\ main(\textcolor{keywordtype}{int}\ argc,\ \textcolor{keywordtype}{char}\ **argv)}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{/*\ Create\ cmp\ object\ */}}
\DoxyCodeLine{\ \ \ \ cmp.run(argc,\ argv);}
\DoxyCodeLine{\}}

\end{DoxyCode}


\doxysubsubsection*{2.\+2.\+4. Summary of {\ttfamily main()} }


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ reference\_impl(\textcolor{keyword}{const}\ Inputs\&...\ in,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Outputs\&...\ \ \ \ \ \ out);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ optimized\_impl(\textcolor{keyword}{const}\ Inputs\&...\ in,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Outputs\&...\ \ \ \ \ \ out);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keywordtype}{int}\ main(\textcolor{keywordtype}{int}\ argc,\ \textcolor{keywordtype}{char}**\ argv)}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{classcomppare_1_1_input_context}{comppare::InputContext}}<Inputs...>}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ ::OutputContext<Outputs...>\ }
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ cmp(in...);}
\DoxyCodeLine{\ \ \ \ }
\DoxyCodeLine{\ \ \ \ cmp.set\_reference(\textcolor{stringliteral}{"{}Reference"{}},\ reference\_impl);}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ cmp.add(\textcolor{stringliteral}{"{}Optimized"{}},\ optimized\_impl);}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ cmp.run(argc,\ argv);}
\DoxyCodeLine{\}}

\end{DoxyCode}
 For more concrete example, please see examples.

\doxysubsection*{2.\+3. Google Benchmark Plugin}

\doxysubsubsubsection*{{\ttfamily google\+\_\+benchmark()} }

Attaches the Google Benchmark plugin when calling \`{}set\+\_\+reference\`{} or \`{}add\`{}, enabling google benchmark to the current implementation.

\DoxyHorRuler{0}


\doxysubsubsubsubsection*{Context }

Member of an internal struct


\begin{DoxyCode}{0}
\DoxyCodeLine{comppare::Impl}

\end{DoxyCode}


\doxysubsubsubsubsection*{Signature }


\begin{DoxyCode}{0}
\DoxyCodeLine{benchmark::internal::Benchmark*\ google\_benchmark();}

\end{DoxyCode}


\doxysubsubsubsubsection*{Returns }


\begin{DoxyItemize}
\item {\bfseries{{\ttfamily benchmark\+::internal\+::\+Benchmark\texorpdfstring{$\ast$}{*}}}} Pointer to the underlying Google Benchmark {\ttfamily Benchmark} instance. Use this to chain additional benchmark configuration calls (e.\+g. {\ttfamily -\/\texorpdfstring{$>$}{>}Arg()}, {\ttfamily -\/\texorpdfstring{$>$}{>}Threads()}, {\ttfamily -\/\texorpdfstring{$>$}{>}Unit()}, etc.).
\end{DoxyItemize}

\doxysubsubsubsubsection*{Detailed Description }

After registering an implementation via {\ttfamily set\+\_\+reference} or {\ttfamily add}, both functions return a reference to an internal struct {\ttfamily comppare\+::\+Impl} \doxylink{md_docs_2user__guide_comppare_main_add_returnimpl}{(see here)}. {\ttfamily google\+\_\+benchmark()} attaches the plugin to the current implementation. The returned pointer allows you to further customize the benchmark before execution.

\doxysubsubsubsubsection*{Example }


\begin{DoxyCode}{0}
\DoxyCodeLine{cmp.set\_reference(\textcolor{stringliteral}{"{}Reference"{}},\ reference\_impl)}
\DoxyCodeLine{\ \ \ .google\_benchmark();}
\DoxyCodeLine{}
\DoxyCodeLine{cmp.add(\textcolor{stringliteral}{"{}Optimized"{}},\ optimized\_impl)}
\DoxyCodeLine{\ \ \ .google\_benchmark();}
\DoxyCodeLine{}
\DoxyCodeLine{cmp.run(argc,\ argv);}

\end{DoxyCode}


\doxysubsubsection*{Manual Timing with Google Benchmark }

Enable manual timing for any registered implementation by appending {\ttfamily -\/\texorpdfstring{$>$}{>}Use\+Manual\+Time()} to the Benchmark\texorpdfstring{$\ast$}{*} returned from google\+\_\+benchmark(). This instructs Google Benchmark to measure only the intervals you explicitly mark inside your implementation, with Manual Timer Macros or Set\+Iteration\+Time() macro.

{\ttfamily Use\+Manual\+Time()} is a Google Benchmark API call that switches the benchmark into Manual Timing mode. \href{https://google.github.io/benchmark/user_guide.html\#manual-timing}{\texttt{(See Google Benchmark\textquotesingle{}s Documentation)}}


\begin{DoxyCode}{0}
\DoxyCodeLine{impl\_manualtimer\_macro(...)}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{comppare_8hpp_a03adebee29527207e43a1b362d77fe65}{HOTLOOPSTART}};}
\DoxyCodeLine{\ \ \ \ ...}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{comppare_8hpp_a09770669e2181c6a712ea4512ded4e36}{MANUAL\_TIMER\_START}};}
\DoxyCodeLine{\ \ \ \ ...}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{comppare_8hpp_a6cde3e9e2e72f32aeb69aba4a09f353f}{MANUAL\_TIMER\_END}};}
\DoxyCodeLine{\ \ \ \ ...}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{comppare_8hpp_a3f983d0c821f40a98683debcc90a1e97}{HOTLOOPEND}};}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{impl\_setitertime\_macro(...)}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{comppare_8hpp_a03adebee29527207e43a1b362d77fe65}{HOTLOOPSTART}};}
\DoxyCodeLine{\ \ \ \ ...}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordtype}{double}\ elapsed\_us;}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{namespacecomppare_1_1plugin_1_1google__benchmark_a2892805822e4a27405a97111b08f8983}{SetIterationTime}}(elapsed\_us)}
\DoxyCodeLine{\ \ \ \ ...}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{comppare_8hpp_a3f983d0c821f40a98683debcc90a1e97}{HOTLOOPEND}};}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keywordtype}{int}\ main()}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ cmp.set\_reference(\textcolor{stringliteral}{"{}Manual\ Timer\ Macro"{}},\ impl\_manualtimer\_macro)}
\DoxyCodeLine{\ \ \ \ .google\_benchmark()\ }
\DoxyCodeLine{\ \ \ \ \ \ \ \ -\/>UseManualTime();}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ cmp.add(\textcolor{stringliteral}{"{}SetIterationTime\ Macro"{}},\ impl\_setitertime\_macro)}
\DoxyCodeLine{\ \ \ \ .google\_benchmark()\ }
\DoxyCodeLine{\ \ \ \ \ \ \ \ -\/>UseManualTime();}
\DoxyCodeLine{\}}

\end{DoxyCode}


\doxysubsection*{2.\+4. {\ttfamily Do\+Not\+Optimize()}}

For a deep dive into the working principle of {\ttfamily Do\+Not\+Optimize()} please visit examples/advanced\+\_\+demo/\+Do\+Not\+Optimize

\doxysubsubsection*{Disclaimer }

I, LF Fung, am not the author of {\ttfamily Do\+Not\+Optimize()}. The implementation of {\ttfamily \doxylink{namespacecomppare_a047cefc5aebc47d079d502c2d189fe12}{comppare\+::\+Do\+Not\+Optimize()}} is a verbatim of Google Benchmark\textquotesingle{}s {\ttfamily benchmark\+::\+Do\+Not\+Optimize()}.

\doxysubsubsection*{References\+: }


\begin{DoxyEnumerate}
\item \href{https://www.youtube.com/watch?v=nXaxk27zwlk&t=3319s}{\texttt{Cpp\+Con 2015\+: Chandler Carruth "{}\+Tuning C++\+: Benchmarks, and CPUs, and Compilers! Oh My!"{}}} ~\newline

\item \href{https://github.com/google/benchmark}{\texttt{Google Benchmark Github Repository}} ~\newline

\end{DoxyEnumerate}

\doxysubsubsection*{2.\+4.\+1. Problem with Compiler Optimsation }

Compiler optimization can sometimes remove operations and variables completely.

For instance in the following function\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ SAXPY(\textcolor{keyword}{const}\ \textcolor{keywordtype}{float}\ a,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{float}*\ x,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{float}*\ y)}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordtype}{float}\ yout;}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ N;\ ++i)}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ yout\ =\ a\ *\ x[i]\ +\ y[i];}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{\}}

\end{DoxyCode}


When compiling at high optimization, the compiler realizes {\ttfamily yout} is just a temporary that’s never used elsewhere. As a result, {\ttfamily yout} is optimized out, and thus the whole saxpy operation would be optimized out.

\doxysubsubsubsection*{SAXPY() in Assembly }

When SAXPY() is compiled in AArch64 with Optimisation {\ttfamily -\/O3} 
\begin{DoxyCode}{0}
\DoxyCodeLine{\_\_Z5SAXPYfPKfS0\_:\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ;\ @\_Z5SAXPYfPKfS0\_}
\DoxyCodeLine{\ \ \ \ .cfi\_startproc}
\DoxyCodeLine{;\ \%bb.0:}
\DoxyCodeLine{\ \ \ \ ret}
\DoxyCodeLine{\ \ \ \ .cfi\_endproc}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ;\ -\/-\/\ End\ function}

\end{DoxyCode}
 The function body is practically empty\+: a single {\ttfamily ret} which is “return from subroutine” \href{https://developer.arm.com/documentation/dui0802/b/A64-General-Instructions/RET}{\texttt{Arm A64 Instruction Set\+: {\bfseries{RET}}}}. In simple terms, it just returns — nothing happens.

\doxysubsubsection*{2.\+4.\+2. Solution -- Google Benchmark\textquotesingle{}s Do\+Not\+Optimize() }

Optimization is important to understand the performance of particular operations in production builds. This creates the conflicting ideas of {\ttfamily optimize} but {\ttfamily do not optimize away}. This was solved by Google in their \href{https://github.com/google/benchmark}{\texttt{benchmark}} -- a microbenchmarking library. Google Benchmark provides {\ttfamily benchmark\+::\+Do\+Not\+Optimize()} to prevent variables from being optimized away.

With the same SAXPY function, we simply add Do\+Not\+Optimize() around the temporary variable {\ttfamily yout} 
\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ SAXPY\_DONOTOPTIMIZE(\textcolor{keyword}{const}\ \textcolor{keywordtype}{float}\ a,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{float}*\ x,\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{float}*\ y)}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordtype}{float}\ yout;}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{int}\ i\ =\ 0;\ i\ <\ N;\ ++i)}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ yout\ =\ a\ *\ x[i]\ +\ y[i];}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \mbox{\hyperlink{namespacecomppare_a047cefc5aebc47d079d502c2d189fe12}{DoNotOptimize}}(yout);}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{\}}

\end{DoxyCode}
 This {\ttfamily Do\+Not\+Optimize} call tells the compiler not to eliminate the temporary variable, so the operation itself won’t be optimized away.

\doxysubsubsubsection*{SAXPY\+\_\+\+DONOTOPTIMIZE() in Assembly }

When SAXPY\+\_\+\+DONOTOPTIMIZE() is compiled in AArch64 with Optimisation {\ttfamily -\/O3}\+:


\begin{DoxyPre}{\ttfamily 
   5 \_\_Z19SAXPY\_DONOTOPTIMIZEfPKfS0\_:        ; @\_Z19SAXPY\_DONOTOPTIMIZEfPKfS0\_
6       .cfi\_startproc
7 ; bb.0:
8       sub     sp, sp, \#16
9       .cfi\_def\_cfa\_offset 16
10      mov     w8, \#16960
11      movk    w8, \#15, lsl \#16
12      add     x9, sp, \#4
13      add     x10, sp, \#8
14 LBB0\_1:                                 ; =>This Inner Loop Header: Depth=1
15      ldr     s1, [x0], \#4
16      ldr     s2, [x1], \#4
17      fmadd   s1, s0, s1, s2
18      str     s1, [sp, \#4]
19      str     x9, [sp, \#8]
20      ; InlineAsm Start
21      ; InlineAsm End
22      subs    x8, x8, \#1
23      b.ne    LBB0\_1
24 ; bb.2:
25      add     sp, sp, \#16
26      ret
27      .cfi\_endproc
28                                         ; -\/-\/ End function
}\end{DoxyPre}


~\newline


Further inspection reveals the Fused-\/\+Multiply-\/\+Add instruction -- indicating that SAXPY operation was not optimized away. 
\begin{DoxyPre}{\ttfamily 
17      fmadd   s0, s0, s1, s2
}\end{DoxyPre}


\href{https://developer.arm.com/documentation/ddi0602/2025-06/SIMD-FP-Instructions/FMADD--Floating-point-fused-multiply-add--scalar--}{\texttt{Reference to Arm A64 Instruction Set\+: {\bfseries{FMADD}}}}

\doxysubsubsection*{2.\+4.\+3. {\ttfamily \doxylink{namespacecomppare_a047cefc5aebc47d079d502c2d189fe12}{comppare\+::\+Do\+Not\+Optimize()}} }

Provided the usefulness of Google Benchmark\textquotesingle{}s {\ttfamily benchmark\+::\+Do\+Not\+Optimize()}, comppare includes a verbatim of {\ttfamily benchmark\+::\+Do\+Not\+Optimize()}.

Example\+: 
\begin{DoxyCode}{0}
\DoxyCodeLine{impl(...)}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \ \ ...}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{namespacecomppare_a047cefc5aebc47d079d502c2d189fe12}{comppare::DoNotOptimize}}(temporary\_variable);}
\DoxyCodeLine{\ \ \ \ ...}
\DoxyCodeLine{\}}

\end{DoxyCode}
 